<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --duke-navy: #012169;
            --duke-blue: #00539B;
            --duke-light-blue: #5B9BD5;
            --duke-gray: #666666;
            --duke-light-gray: #E5E5E5;
            --duke-white: #FFFFFF;
            --duke-black: #262626;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            color: var(--duke-black);
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--duke-navy);
            color: var(--duke-white);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin: 0;
        }
        .controls {
            background-color: var(--duke-white);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: var(--duke-gray);
            font-weight: 500;
        }
        input[type="date"], button {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
        }
        button {
            background-color: var(--duke-blue);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            padding: 10px 15px;
            align-self: flex-end;
        }
        button:hover { background-color: var(--duke-light-blue); }

        /* Tab Styles */
        .tab-bar {
            display: flex;
            border-bottom: 2px solid var(--duke-light-gray);
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--duke-gray);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: color 0.3s, border-color 0.3s;
        }
        .tab-button:hover { color: var(--duke-blue); }
        .tab-button.active {
            color: var(--duke-navy);
            border-bottom-color: var(--duke-navy);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: var(--duke-white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin: 0 0 15px 0;
            color: var(--duke-navy);
        }
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .kpi-label {
            font-size: 0.9rem;
            color: var(--duke-gray);
            margin: 0 0 5px 0;
        }
        .kpi-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--duke-blue);
            margin: 0;
        }
        .chart-container {
            position: relative;
            flex-grow: 1;
            min-height: 300px;
        }
        .table-container {
            overflow-x: auto;
            flex-grow: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--duke-light-gray);
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tbody tr:hover { background-color: #f1f5f9; }
        .loader {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }
    </style>
</head>

<body>
    <header><h1>Marketing Analytics Dashboard</h1></header>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="control-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
            </div>
            <button id="filterButton">Filter</button>
        </div>

        <div class="tab-bar">
            <button class="tab-button active" onclick="openTab('web')">Web</button>
            <button class="tab-button" onclick="openTab('social')">Social</button>
            <button class="tab-button" onclick="openTab('email')">Email</button>
            <button class="tab-button" onclick="openTab('youtube')">YouTube</button>
        </div>
        
        <div id="loader" class="loader">Loading and processing data...</div>

        <div id="dashboard-content" style="display: none;">
            <div id="web" class="tab-content active">
                <div class="dashboard">
                    <div class="card" id="web-analytics">
                        <h2 class="card-title">Web KPIs</h2>
                        <div class="kpi-container">
                            <div class="kpi"><p class="kpi-label">Total Users</p><p class="kpi-value" id="totalUsers">0</p></div>
                            <div class="kpi"><p class="kpi-label">New Users</p><p class="kpi-value" id="newUsers">0</p></div>
                            <div class="kpi"><p class="kpi-label">Total Sessions</p><p class="kpi-value" id="totalSessions">0</p></div>
                            <div class="kpi"><p class="kpi-label">Engaged Sessions</p><p class="kpi-value" id="engagedSessions">0</p></div>
                        </div>
                    </div>
                    <div class="card"><h2 class="card-title">Sessions by Source</h2><div class="chart-container"><canvas id="trafficSourcesChart"></canvas></div></div>
                    <div class="card"><h2 class="card-title">Users by Country</h2><div class="chart-container"><canvas id="countryChart"></canvas></div></div>
                    <div class="card" style="grid-column: 1 / -1;"><h2 class="card-title">Top Pages</h2><div class="table-container"><table id="pagesTable"><thead><tr><th>Page Title</th><th>Views</th><th>Users</th></tr></thead><tbody></tbody></table></div></div>
                    <div class="card" style="grid-column: 1 / -1;"><h2 class="card-title">UTM Campaign Performance</h2><div class="table-container"><table id="utmTable"><thead><tr><th>Campaign</th><th>Engaged Sessions</th><th>Conversions</th><th>Engagement Rate</th></tr></thead><tbody></tbody></table></div></div>
                </div>
            </div>

            <div id="social" class="tab-content">
                <div class="dashboard">
                     <div class="card" id="social-kpis">
                        <h2 class="card-title">Social KPIs</h2>
                        <div class="kpi-container">
                            <div class="kpi"><p class="kpi-label">Total Followers</p><p class="kpi-value" id="totalFollowers">0</p></div>
                            <div class="kpi"><p class="kpi-label">Impressions</p><p class="kpi-value" id="totalImpressions">0</p></div>
                            <div class="kpi"><p class="kpi-label">Engagement Rate</p><p class="kpi-value" id="avgEngagementRate">0%</p></div>
                            <div class="kpi"><p class="kpi-label">Link Clicks</p><p class="kpi-value" id="totalLinkClicks">0</p></div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 2;"><h2 class="card-title">Followers by Platform</h2><div class="chart-container"><canvas id="followersByPlatformChart"></canvas></div></div>
                </div>
            </div>

            <div id="email" class="tab-content">
                 <div class="dashboard">
                     <div class="card" id="email-kpis">
                        <h2 class="card-title">Email KPIs</h2>
                        <div class="kpi-container">
                            <div class="kpi"><p class="kpi-label">Total Subscribers</p><p class="kpi-value" id="totalSubscribers">0</p></div>
                            <div class="kpi"><p class="kpi-label">Avg. Open Rate</p><p class="kpi-value" id="avgOpenRate">0%</p></div>
                            <div class="kpi"><p class="kpi-label">Avg. Click Rate</p><p class="kpi-value" id="avgClickRate">0%</p></div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: 1 / -1;"><h2 class="card-title">Campaign Performance</h2><div class="table-container"><table id="emailCampaignTable"><thead><tr><th>Campaign</th><th>Subject</th><th>Open Rate</th><th>Click Rate</th></tr></thead><tbody></tbody></table></div></div>
                </div>
            </div>

            <div id="youtube" class="tab-content">
                <div class="dashboard">
                     <div class="card" id="youtube-kpis">
                        <h2 class="card-title">YouTube KPIs</h2>
                        <div class="kpi-container">
                            <div class="kpi"><p class="kpi-label">Total Views</p><p class="kpi-value" id="totalViews">0</p></div>
                            <div class="kpi"><p class="kpi-label">Total Subscribers</p><p class="kpi-value" id="ytSubscribers">0</p></div>
                            <div class="kpi"><p class="kpi-label">Watch Time (Hours)</p><p class="kpi-value" id="totalWatchTime">0</p></div>
                            <div class="kpi"><p class="kpi-label">Avg. View Duration</p><p class="kpi-value" id="avgViewDuration">0s</p></div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: 1 / -1;"><h2 class="card-title">Top Videos</h2><div class="table-container"><table id="youTubeVideoTable"><thead><tr><th>Video Title</th><th>Views</th><th>Watch Time (Hours)</th><th>Likes</th></tr></thead><tbody></tbody></table></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyAqoLAJLVZyScFX6cG4eSJiroMkA4KH-nE'; 
        const FOLDER_ID = '1Kc8tHlVmPYMtNipycBRd0HSC61u2uLDP';
        const SHEET_NAME = 'Sheet1'; // Assumes all files use this sheet name

        // Maps the exact filename in Google Drive to the key used in the script.
        const FILENAME_TO_KEY_MAP = {
            'GA_Traffic_Acquisition.xlsx - Sheet1.csv': 'ga',
            'GA_Demographics.xlsx - Sheet1.csv': 'demographics',
            'GA_Pages_And_Screens.xlsx - Sheet1.csv': 'pages',
            'GA_UTMs.xlsx - Sheet1.csv': 'utm',
            'Social_Analytics.csv': 'social', // Assumed name for new Social data
            'Email_Analytics.csv': 'email',     // Assumed name for new Email data
            'YouTube_Analytics.csv': 'youtube'  // Assumed name for new YouTube data
        };
        // --- END CONFIGURATION ---

        const chartInstances = {};
        const processedData = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            document.getElementById('filterButton').addEventListener('click', updateDashboard);
        });
        
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function getSpreadsheetIdsFromFolder() {
            const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}' in parents and trashed=false&key=${API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Google Drive API error! Status: ${response.status}. Check Folder ID and API Key permissions.`);
            
            const data = await response.json();
            if (!data.files) throw new Error('No files found in the specified Google Drive folder.');

            const spreadsheetIds = {};
            data.files.forEach(file => {
                const key = FILENAME_TO_KEY_MAP[file.name];
                if (key) {
                    spreadsheetIds[key] = file.id;
                }
            });
            return spreadsheetIds;
        }

        async function loadAllData() {
            const loader = document.getElementById('loader');
            const dashboard = document.getElementById('dashboard-content');
            loader.style.display = 'block';
            dashboard.style.display = 'none';

            try {
                const spreadsheetIds = await getSpreadsheetIdsFromFolder();
                const keys = Object.keys(spreadsheetIds);
                
                const promises = keys.map(key => {
                    const sheetId = spreadsheetIds[key];
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${SHEET_NAME}?key=${API_KEY}`;
                    return fetch(url)
                        .then(res => res.json())
                        .then(data => ({ key, data: googleSheetsValuesToObjects(data.values) }));
                });

                const results = await Promise.all(promises);
                const rawData = results.reduce((acc, { key, data }) => {
                    acc[key] = data;
                    return acc;
                }, {});

                processAllData(rawData);
                setDefaultDates();
                updateDashboard();
                
                loader.style.display = 'none';
                dashboard.style.display = 'block';

            } catch (error) {
                loader.textContent = `Error: ${error.message}`;
                console.error(error);
            }
        }
        
        function processAllData(rawData) {
            let minDate = new Date();
            let maxDate = new Date(1970, 0, 1);
            const addDate = (date) => {
                if (date) {
                    if (date < minDate) minDate = date;
                    if (date > maxDate) maxDate = date;
                }
            };
            
            const process = (key, dateColumn) => {
                if (!rawData[key]) return;
                processedData[key] = rawData[key].map(row => {
                    // Normalize date column for different files
                    const dateStr = row[dateColumn] || row['Date'];
                    const date = parseDate(dateStr);
                    addDate(date);
                    return { ...row, date };
                });
            };
            
            // Assuming date columns for each file type
            process('ga', 'Date + hour (YYYYMMDDHH)');
            process('demographics', 'Date + hour (YYYYMMDDHH)');
            process('pages', 'Date + hour (YYYYMMDDHH)');
            process('utm', 'Date + hour (YYYYMMDDHH)');
            process('social', 'Date');
            process('email', 'Date');
            process('youtube', 'Date');

            processedData.minDate = minDate;
            processedData.maxDate = maxDate;
        }

        function updateDashboard() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999);

            const filterByDate = (data) => data ? data.filter(row => row.date >= startDate && row.date <= endDate) : [];

            // Filter all data sources that exist
            const filteredData = {};
            for (const key in processedData) {
                if(Array.isArray(processedData[key])) {
                     filteredData[key] = filterByDate(processedData[key]);
                }
            }

            if (filteredData.ga) updateWebAnalytics(filteredData);
            if (filteredData.social) updateSocialAnalytics(filteredData.social);
            if (filteredData.email) updateEmailAnalytics(filteredData.email);
            if (filteredData.youtube) updateYouTubeAnalytics(filteredData.youtube);
        }

        // --- UPDATE FUNCTIONS FOR EACH TAB ---

        function updateWebAnalytics(data) {
            // This function is mostly the same as before, just uses the passed 'data' object
            // which contains filtered .ga, .demographics, etc.
            let totalUsers = 0, newUsers = 0, engagedSessions = 0, totalSessions = 0;
            data.demographics.forEach(row => {
                totalUsers += parseInt(row['Total users']) || 0;
                newUsers += parseInt(row['New users']) || 0;
                engagedSessions += parseInt(row['Engaged sessions']) || 0;
            });
            data.ga.forEach(row => { totalSessions += parseInt(row['Sessions']) || 0; });
            document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
            document.getElementById('newUsers').textContent = formatNumber(newUsers);
            document.getElementById('totalSessions').textContent = formatNumber(totalSessions);
            document.getElementById('engagedSessions').textContent = formatNumber(engagedSessions);
            
            const trafficSources = data.ga.reduce((acc, row) => {
                const source = row['Session source / medium'] || 'Unknown';
                acc[source] = (acc[source] || 0) + (parseInt(row['Sessions']) || 0);
                return acc;
            }, {});
            createOrUpdateChart('trafficSourcesChart', 'pie', trafficSources, 'Sessions by Source / Medium');

            const usersByCountry = data.demographics.reduce((acc, row) => {
                const country = row['Country'];
                if (country && country !== '(not set)') acc[country] = (acc[country] || 0) + (parseInt(row['Total users']) || 0);
                return acc;
            }, {});
            createOrUpdateChart('countryChart', 'bar', usersByCountry, 'Top 5 Countries by Users', { indexAxis: 'y', topN: 5 });

            updateTable('pagesTable', data.pages, ['Page title and screen class', 'Views', 'Total users'], 10, 'Views');
            updateTable('utmTable', data.utm, ['Manual campaign name', 'Engaged sessions', 'Key events', 'Engagement rate'], 10, 'Engaged sessions');
        }
        
        function updateSocialAnalytics(data) {
            let totalFollowers = 0, totalImpressions = 0, totalClicks = 0, totalEngagements = 0;
            const followersByPlatform = data.reduce((acc, row) => {
                const platform = row['Platform'] || 'Unknown';
                acc[platform] = (acc[platform] || 0) + (parseInt(row['Followers Gained']) || 0);
                totalImpressions += parseInt(row['Impressions']) || 0;
                totalClicks += parseInt(row['Link Clicks']) || 0;
                totalEngagements += parseInt(row['Engagements']) || 0;
                return acc;
            }, {});

            // For KPIs that are snapshots (like total followers), we should take the last value
            if (data.length > 0) {
                 totalFollowers = parseInt(data[data.length-1]['Total Followers']) || 0;
            }
            const engagementRate = totalImpressions > 0 ? ((totalEngagements / totalImpressions) * 100).toFixed(2) : 0;
            
            document.getElementById('totalFollowers').textContent = formatNumber(totalFollowers);
            document.getElementById('totalImpressions').textContent = formatNumber(totalImpressions);
            document.getElementById('avgEngagementRate').textContent = `${engagementRate}%`;
            document.getElementById('totalLinkClicks').textContent = formatNumber(totalClicks);

            createOrUpdateChart('followersByPlatformChart', 'bar', followersByPlatform, 'Followers Gained by Platform');
        }

        function updateEmailAnalytics(data) {
             let totalSubscribers = 0, totalOpens = 0, totalClicks = 0, campaignCount = 0;
             data.forEach(row => {
                 totalOpens += parseFloat(row['Open Rate']) || 0;
                 totalClicks += parseFloat(row['Click Rate']) || 0;
                 campaignCount++;
             });
             if (data.length > 0) {
                 totalSubscribers = parseInt(data[data.length - 1]['Total Subscribers']) || 0;
             }
             const avgOpen = campaignCount > 0 ? (totalOpens / campaignCount).toFixed(2) : 0;
             const avgClick = campaignCount > 0 ? (totalClicks / campaignCount).toFixed(2) : 0;

             document.getElementById('totalSubscribers').textContent = formatNumber(totalSubscribers);
             document.getElementById('avgOpenRate').textContent = `${avgOpen}%`;
             document.getElementById('avgClickRate').textContent = `${avgClick}%`;
             
             updateTable('emailCampaignTable', data, ['Campaign Name', 'Subject Line', 'Open Rate', 'Click Rate'], 10, 'Date');
        }

        function updateYouTubeAnalytics(data) {
            let totalViews = 0, totalSubs = 0, totalWatchTime = 0, totalDuration = 0, videoCount = 0;
            data.forEach(row => {
                totalViews += parseInt(row['Views']) || 0;
                totalWatchTime += parseFloat(row['Watch Time (Hours)']) || 0;
                totalDuration += parseFloat(row['Avg View Duration (sec)']) || 0;
                videoCount++;
            });
            if (data.length > 0) {
                 totalSubs = parseInt(data[data.length - 1]['Total Subscribers']) || 0;
            }
            const avgDuration = videoCount > 0 ? (totalDuration / videoCount).toFixed(0) : 0;
            
            document.getElementById('totalViews').textContent = formatNumber(totalViews);
            document.getElementById('ytSubscribers').textContent = formatNumber(totalSubs);
            document.getElementById('totalWatchTime').textContent = formatNumber(totalWatchTime.toFixed(1));
            document.getElementById('avgViewDuration').textContent = `${avgDuration}s`;

            updateTable('youTubeVideoTable', data, ['Video Title', 'Views', 'Watch Time (Hours)', 'Likes'], 10, 'Views');
        }


        // --- UTILITY & HELPER FUNCTIONS ---

        function setDefaultDates() {
            const endDateInput = document.getElementById('endDate');
            const startDateInput = document.getElementById('startDate');
            if (processedData.maxDate) {
                 const endDate = processedData.maxDate;
                 const startDate = new Date(endDate);
                 startDate.setDate(startDate.getDate() - 30);
                 endDateInput.value = endDate.toISOString().split('T')[0];
                 startDateInput.value = startDate.toISOString().split('T')[0];
            }
        }
        
        function formatNumber(num) { return Number(num).toLocaleString(); }
        function destroyChart(chartId) { if (chartInstances[chartId]) chartInstances[chartId].destroy(); }

        function googleSheetsValuesToObjects(values) {
            if (!values || values.length < 2) return [];
            const headers = values[0];
            return values.slice(1).map(row => headers.reduce((obj, header, i) => {
                obj[header] = row[i];
                return obj;
            }, {}));
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Try YYYYMMDD format first
            if (/^\d{8}/.test(String(dateStr))) {
                const s = String(dateStr);
                return new Date(s.substring(0, 4), s.substring(4, 6) - 1, s.substring(6, 8));
            }
            // Fallback to standard date parsing
            const date = new Date(dateStr);
            return isNaN(date) ? null : date;
        }

        function createOrUpdateChart(canvasId, type, data, title, options = {}) {
            destroyChart(canvasId);
            const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
            const finalData = options.topN ? sortedData.slice(0, options.topN) : sortedData;

            const chartData = {
                labels: finalData.map(item => item[0]),
                datasets: [{
                    label: title,
                    data: finalData.map(item => item[1]),
                    backgroundColor: ['#012169', '#00539B', '#5B9BD5', '#A9C4E5', '#E5E5E5', '#666666']
                }]
            };

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: type === 'pie', position: 'bottom' },
                    title: { display: true, text: title }
                }
            };

            chartInstances[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: type,
                data: chartData,
                options: { ...defaultOptions, ...options }
            });
        }
        
        function updateTable(tableId, data, columns, rowLimit, sortColumn) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = '';
            
            const sortedData = [...data].sort((a,b) => (Number(b[sortColumn]) || 0) - (Number(a[sortColumn]) || 0));
            
            sortedData.slice(0, rowLimit).forEach(row => {
                let rowHtml = '<tr>';
                columns.forEach(col => {
                    let value = row[col] || 'N/A';
                    // Format numbers and percentages
                    if (!isNaN(value) && Number(value) > 100) value = formatNumber(Number(value));
                    if (String(col).toLowerCase().includes('rate')) value = `${parseFloat(value || 0).toFixed(2)}%`;
                    rowHtml += `<td>${value}</td>`;
                });
                rowHtml += '</tr>';
                tableBody.innerHTML += rowHtml;
            });
        }

    </script>
</body>
</html>