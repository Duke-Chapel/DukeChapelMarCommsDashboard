<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --duke-navy: #012169;
            --duke-blue: #00539B;
            --duke-light-blue: #5B9BD5;
            --duke-gray: #666666;
            --duke-light-gray: #E5E5E5;
            --duke-white: #FFFFFF;
            --duke-black: #262626;
            --success-green: #28A745;
            --danger-red: #DC3545;
            --warning-yellow: #FFC107;
            --info-blue: #17A2B8;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            --shadow-xl: 0 16px 32px rgba(0,0,0,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
            color: var(--duke-black);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: var(--duke-navy);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            text-align: center;
        }
        
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        /* Google Sheets Configuration Section */
        .config-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--duke-light-blue);
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .config-title {
            font-size: 1.5rem;
            color: var(--duke-navy);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .config-status.connected {
            background: #e8f5e9;
            color: var(--success-green);
        }
        
        .config-status.disconnected {
            background: #ffebee;
            color: var(--danger-red);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .config-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-group label {
            font-weight: 600;
            color: var(--duke-gray);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .config-group input {
            padding: 12px 15px;
            border: 1px solid var(--duke-light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .config-group input:focus {
            outline: none;
            border-color: var(--duke-blue);
            box-shadow: 0 0 0 3px rgba(0, 83, 155, 0.1);
        }
        
        .connect-btn {
            background: var(--duke-blue);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connect-btn:hover {
            background: var(--duke-navy);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .connect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .sheets-instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .sheets-instructions h4 {
            color: var(--duke-navy);
            margin-bottom: 10px;
        }
        
        .sheets-instructions ol {
            padding-left: 20px;
            color: #555;
        }
        
        .sheets-instructions li {
            margin-bottom: 8px;
        }
        
        /* Controls Section */
        .controls {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
            display: none;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            color: var(--duke-gray);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-group input,
        .control-group select {
            padding: 10px 15px;
            border: 1px solid var(--duke-light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--duke-blue);
            box-shadow: 0 0 0 3px rgba(0, 83, 155, 0.1);
        }
        
        .quick-range-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quick-range-btn {
            background: #f8f9fa;
            color: var(--duke-navy);
            border: 1px solid var(--duke-light-gray);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-range-btn:hover {
            background: var(--duke-blue);
            color: white;
            border-color: var(--duke-blue);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .update-btn {
            background: var(--duke-blue);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .update-btn:hover {
            background: var(--duke-navy);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card.full-width {
            grid-column: 1 / -1;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--duke-navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            font-size: 1.5rem;
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--duke-blue);
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--duke-navy);
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--duke-gray);
            font-weight: 500;
        }
        
        .metric-change {
            font-size: 0.75rem;
            margin-top: 10px;
            font-weight: 600;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .metric-change.positive {
            color: var(--success-green);
            background: rgba(40, 167, 69, 0.1);
        }
        
        .metric-change.negative {
            color: var(--danger-red);
            background: rgba(220, 53, 69, 0.1);
        }
        
        /* Chart Container */
        .chart-container {
            width: 100%;
            height: 350px;
            margin-top: 20px;
            position: relative;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid var(--duke-light-gray);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--duke-light-gray);
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--duke-gray);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        /* Section Headers */
        .section-header {
            background: linear-gradient(135deg, var(--duke-navy), var(--duke-blue));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 40px 0 25px 0;
            text-align: center;
            font-size: 1.75rem;
            font-weight: 700;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 15s linear infinite;
        }
        
        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--duke-gray);
            font-size: 1.1rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--duke-blue);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error State */
        .error {
            background: #fee;
            color: var(--danger-red);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--danger-red);
            font-weight: 500;
        }
        
        /* Date Range Info */
        .date-range-info {
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--duke-navy);
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Tabs */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--duke-light-gray);
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--duke-gray);
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }
        
        .tab-button:hover {
            color: var(--duke-navy);
        }
        
        .tab-button.active {
            color: var(--duke-blue);
            font-weight: 600;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--duke-blue);
        }
        
        /* Comparison Styles */
        .comparison-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .comparison-badge.previous {
            background: #e3f2fd;
            color: var(--duke-blue);
        }
        
        .comparison-badge.year {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--duke-gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--duke-navy);
        }
        
        .empty-state p {
            font-size: 1rem;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Info Boxes */
        .info-box {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .info-box.warning {
            background: #fff8e1;
            border-left: 4px solid var(--warning-yellow);
        }
        
        .info-box.info {
            background: #e3f2fd;
            border-left: 4px solid var(--info-blue);
        }
        
        .info-box.error {
            background: #fee;
            border-left: 4px solid var(--danger-red);
        }
        
        .info-box h4 {
            margin-bottom: 10px;
            color: var(--duke-navy);
        }
        
        .info-box p {
            margin: 0 0 10px 0;
            color: #666;
        }
        
        .info-box ul {
            margin: 0;
            padding-left: 20px;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Duke Chapel Analytics</h1>
            <p>Comprehensive Marketing Performance Dashboard</p>
        </div>
    </div>
    
    <div class="container">
        <div class="config-section" id="configSection">
            <div class="config-header">
                <h3 class="config-title">
                    <span>üìä</span> Google Sheets Configuration
                </h3>
                <div class="config-status disconnected" id="connectionStatus">
                    ‚ùå Not Connected
                </div>
            </div>
            
            <div class="config-grid">
                <div class="config-group">
                    <label>Google Drive Folder ID</label>
                    <input type="text" id="folderId" placeholder="Enter your Google Drive folder ID">
                </div>
                <div class="config-group">
                    <label>API Key</label>
                    <input type="text" id="apiKey" placeholder="Enter your Google Drive/Sheets API key">
                </div>
            </div>
            
            <button class="connect-btn" id="connectBtn" onclick="connectToSheets()">
                <span>üîó</span> Connect to Google Drive Folder
            </button>
            
            <div class="sheets-instructions">
                <h4>üöÄ Setup Instructions:</h4>
                <ol>
                    <li>Create a Google Drive folder for your Duke Chapel analytics data</li>
                    <li>Create separate Google Sheets for each data source, ensuring the sheet names match the expected names below:
                        <ul style="margin: 10px 0; padding-left: 20px; columns: 2;">
                            <li><strong>GA_Demographics</strong></li>
                            <li><strong>GA_Traffic_Acquisition</strong></li>
                            <li><strong>GA_Pages_And_Screens</strong></li>
                            <li><strong>GA_UTMs</strong></li>
                            <li><strong>FB_Reach</strong></li>
                            <li><strong>FB_Interactions</strong></li>
                            <li><strong>FB_Follows</strong></li>
                            <li><strong>FB_Views</strong></li>
                            <li><strong>FB_Link_Clicks</strong></li>
                            <li><strong>FB_Visits</strong></li>
                            <li><strong>FB_Audience</strong></li>
                            <li><strong>IG_Reach</strong></li>
                            <li><strong>IG_Interactions</strong></li>
                            <li><strong>IG_Follows</strong></li>
                            <li><strong>IG_Views</strong></li>
                            <li><strong>IG_Link_Clicks</strong></li>
                            <li><strong>IG_Visits</strong></li>
                            <li><strong>IG_Audience</strong></li>
                            <li><strong>Email_Campaign_Performance</strong></li>
                            <li><strong>YouTube_Content</strong></li>
                            <li><strong>YouTube_Age</strong></li>
                            <li><strong>YouTube_Gender</strong></li>
                            <li><strong>YouTube_Geography</strong></li>
                            <li><strong>YouTube_Subscription_Status</strong></li>
                        </ul>
                    </li>
                    <li>Make the folder publicly viewable (Share ‚Üí Anyone with the link can view)</li>
                    <li>Get a Google Drive API key from <a href="https://console.developers.google.com" target="_blank">Google Cloud Console</a> (enable both Drive and Sheets APIs)</li>
                    <li>Copy the Folder ID from the Drive URL (after /folders/)</li>
                    <li>Enter both values above and click Connect</li>
                </ol>
            </div>
        </div>
        
        <div class="controls" id="controls">
            <div class="quick-range-buttons">
                <button class="quick-range-btn" onclick="setDateRange(7)">Last 7 Days</button>
                <button class="quick-range-btn" onclick="setDateRange(30)">Last 30 Days</button>
                <button class="quick-range-btn" onclick="setDateRange(90)">Last 3 Months</button>
                <button class="quick-range-btn" onclick="setDateRange(180)">Last 6 Months</button>
                <button class="quick-range-btn" onclick="setDateRange(365)">Last Year</button>
                <button class="quick-range-btn" onclick="selectFullRange()">All Time</button>
            </div>
            
            <div class="controls-grid">
                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="control-group">
                    <label>Compare With</label>
                    <select id="compareType">
                        <option value="none">No Comparison</option>
                        <option value="previous">Previous Period</option>
                        <option value="year">Same Period Last Year</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="update-btn" onclick="updateDashboard()">
                    <span>üîÑ</span> Update Dashboard
                </button>
            </div>
            
            <div class="date-range-info" id="dateRangeInfo" style="display: none;">
                <span>üìÖ</span>
                <span id="dateRangeText"></span>
            </div>
        </div>
        
        <div id="dashboard"></div>
    </div>

    <script>
        // Global state
        let processedData = {};
        let currentDateRange = { start: null, end: null };
        let sheetsConfig = {
            folderId: '',
            apiKey: '',
            connected: false,
            discoveredSheets: {}
        };
        
        // Expected Google Sheets and their corresponding data files
        const EXPECTED_SHEETS = {
            'GA_Demographics': 'GA_Demographics.csv',
            'GA_Traffic_Acquisition': 'GA_Traffic_Acquisition.csv', 
            'GA_Pages_And_Screens': 'GA_Pages_And_Screens.csv',
            'GA_UTMs': 'GA_UTMs.csv',
            'FB_Reach': 'FB_Reach.csv',
            'FB_Interactions': 'FB_Interactions.csv',
            'FB_Follows': 'FB_Follows.csv',
            'FB_Views': 'FB_Views.csv',
            'FB_Link_Clicks': 'FB_Link_Clicks.csv',
            'FB_Visits': 'FB_Visits.csv',
            'FB_Audience': 'FB_Audience.csv',
            'IG_Reach': 'IG_Reach.csv',
            'IG_Interactions': 'IG_Interactions.csv',
            'IG_Follows': 'IG_Follows.csv',
            'IG_Views': 'IG_Views.csv',
            'IG_Link_Clicks': 'IG_Link_Clicks.csv',
            'IG_Visits': 'IG_Visits.csv',
            'IG_Audience': 'IG_Audience.csv',
            'Email_Campaign_Performance': 'Email_Campaign_Performance.csv',
            'YouTube_Content': 'YouTube_Content.csv',
            'YouTube_Age': 'YouTube_Age.csv',
            'YouTube_Gender': 'YouTube_Gender.csv',
            'YouTube_Geography': 'YouTube_Geography.csv',
            'YouTube_Subscription_Status': 'YouTube_Subscription_Status.csv'
        };
        
        // Connect to Google Sheets
        async function connectToSheets() {
            const folderId = document.getElementById('folderId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!folderId || !apiKey) {
                alert('Please enter both Google Drive Folder ID and API Key');
                return;
            }
            
            const connectBtn = document.getElementById('connectBtn');
            const statusDiv = document.getElementById('connectionStatus');
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<span>‚è≥</span> Connecting...';
            
            try {
                sheetsConfig.folderId = folderId;
                sheetsConfig.apiKey = apiKey;
                saveCredentials();
                
                const driveUrl = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+mimeType='application/vnd.google-apps.spreadsheet'&key=${apiKey}&fields=files(id,name)`;
                
                const response = await fetch(driveUrl);
                if (!response.ok) throw new Error(`Failed to connect: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                if (!data.files || data.files.length === 0) throw new Error('No Google Sheets found in the specified folder');
                
                sheetsConfig.discoveredSheets = {};
                data.files.forEach(file => {
                    if (EXPECTED_SHEETS[file.name]) {
                        sheetsConfig.discoveredSheets[file.name] = file.id;
                    }
                });
                
                sheetsConfig.connected = true;
                statusDiv.className = 'config-status connected';
                statusDiv.innerHTML = '‚úÖ Connected';
                
                document.getElementById('controls').style.display = 'block';
                
                await loadAllSheetData();
                setDefaultDates();
                updateDashboard();
                
                connectBtn.innerHTML = '<span>üîÑ</span> Reconnect';
                connectBtn.disabled = false;
                
                alert(`Successfully connected! Found ${Object.keys(sheetsConfig.discoveredSheets).length} matching sheets.`);
                
            } catch (error) {
                console.error('Connection error:', error);
                alert(`Connection failed: ${error.message}`);
                
                connectBtn.innerHTML = '<span>üîó</span> Connect to Google Drive Folder';
                connectBtn.disabled = false;
                statusDiv.className = 'config-status disconnected';
                statusDiv.innerHTML = '‚ùå Not Connected';
                sheetsConfig.connected = false;
            }
        }
        
        function saveCredentials() {
            const folderId = document.getElementById('folderId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            if (folderId) localStorage.setItem('dukeChapel_folderId', folderId);
            if (apiKey) localStorage.setItem('dukeChapel_apiKey', apiKey);
        }
        
        async function loadAllSheetData() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `<div class="loading"><div class="loading-spinner"></div><p>Loading data from Google Sheets...</p></div>`;
            
            const loadPromises = Object.entries(sheetsConfig.discoveredSheets).map(([sheetName, sheetId]) => {
                const fileName = EXPECTED_SHEETS[sheetName];
                return loadSingleSheet(sheetId, fileName);
            });
            
            await Promise.all(loadPromises);
            dashboard.innerHTML = '';
        }
        
        async function loadSingleSheet(sheetId, fileName) {
            try {
                const metaUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?key=${sheetsConfig.apiKey}&fields=sheets.properties.title`;
                const metaResponse = await fetch(metaUrl);
                if (!metaResponse.ok) throw new Error('Could not fetch sheet metadata');

                const metadata = await metaResponse.json();
                if (!metadata.sheets || metadata.sheets.length === 0) {
                    console.warn(`Sheet for ${fileName} has no tabs.`);
                    return;
                }

                const firstSheetName = metadata.sheets[0].properties.title;
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(firstSheetName)}?key=${sheetsConfig.apiKey}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.warn(`Could not load data from tab "${firstSheetName}" for ${fileName}`);
                    return;
                }
                
                const data = await response.json();
                if (!data.values || data.values.length === 0) {
                    console.warn(`Sheet "${fileName}" is empty`);
                    return;
                }
                
                if (fileName.includes('Audience')) {
                    processedData[fileName] = parseAudienceData(data.values, fileName);
                } else {
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    const parsedData = rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });
                    processedData[fileName] = parsedData;
                }
                
                console.log(`‚úì Loaded data from ${fileName}`);
            } catch (error) {
                console.error(`Error loading ${fileName}:`, error);
            }
        }

        function parseAudienceData(values, fileName) {
            const data = { ageGender: [], topCities: [], topCountries: [] };
            let currentSection = '';
            let headers = [];
            
            for (let i = 0; i < values.length; i++) {
                const row = values[i];
                const firstCell = (row[0] || '').toString().toLowerCase();
                
                if (firstCell.includes('age') && firstCell.includes('gender')) {
                    currentSection = 'ageGender';
                    i++; if (i < values.length) headers = values[i];
                } else if (firstCell.includes('cities')) {
                    currentSection = 'topCities';
                    i++; if (i < values.length) headers = values[i];
                } else if (firstCell.includes('countries')) {
                    currentSection = 'topCountries';
                    i++; if (i < values.length) headers = values[i];
                } else if (currentSection && row.length > 0 && row[0]) {
                    const obj = {};
                    headers.forEach((header, index) => { obj[header] = row[index] || ''; });
                    data[currentSection].push(obj);
                }
            }
            return data;
        }
        
        // Date handling
        function initializeDateControls() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const compareType = document.getElementById('compareType');
            
            startDate.addEventListener('change', validateDateRange);
            endDate.addEventListener('change', validateDateRange);
            compareType.addEventListener('change', () => updateDashboard());
        }
        
        function validateDateRange() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            if (startDate.value && endDate.value && new Date(startDate.value) > new Date(endDate.value)) {
                endDate.value = startDate.value;
            }
        }
        
        function setDefaultDates() {
            const dateRange = getDataDateRange();
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            if (dateRange.min && dateRange.max) {
                const thirtyDaysAgo = new Date(dateRange.max);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                startDate.value = formatDate(Math.max(thirtyDaysAgo, dateRange.min));
                endDate.value = formatDate(dateRange.max);
                
                startDate.min = formatDate(dateRange.min);
                startDate.max = formatDate(dateRange.max);
                endDate.min = formatDate(dateRange.min);
                endDate.max = formatDate(dateRange.max);
            }
        }
        
        function getDataDateRange() {
            let minDate = null, maxDate = null;
            
            Object.entries(processedData).forEach(([fileName, data]) => {
                if (fileName.includes('Audience') || !Array.isArray(data) || data.length === 0) return;
                
                let dateField;
                if (fileName.startsWith('GA_')) dateField = 'Date + hour (YYYYMMDDHH)';
                else if (fileName.includes('FB_') || fileName.includes('IG_')) dateField = 'Date';
                else if (fileName.includes('YouTube_Content')) dateField = 'Video publish time';
                else return;

                data.forEach(row => {
                    const dateValue = row[dateField];
                    if (!dateValue) return;
                    
                    let date;
                    if (typeof dateValue === 'number' || (typeof dateValue === 'string' && /^\d{10,12}$/.test(dateValue))) {
                        const str = dateValue.toString();
                        date = new Date(str.substr(0,4), parseInt(str.substr(4,2))-1, str.substr(6,2));
                    } else {
                        date = new Date(dateValue);
                    }
                    
                    if (!isNaN(date.getTime())) {
                        if (!minDate || date < minDate) minDate = date;
                        if (!maxDate || date > maxDate) maxDate = date;
                    }
                });
            });
            return { min: minDate, max: maxDate };
        }
        
        function setDateRange(days) {
            const dateRange = getDataDateRange();
            if (!dateRange.max) return;
            
            const endDate = new Date(dateRange.max);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - days);
            
            const actualStartDate = dateRange.min && startDate < dateRange.min ? dateRange.min : startDate;
            
            document.getElementById('startDate').value = formatDate(actualStartDate);
            document.getElementById('endDate').value = formatDate(endDate);
            
            updateDashboard();
        }
        
        function selectFullRange() {
            const dateRange = getDataDateRange();
            if (dateRange.min && dateRange.max) {
                document.getElementById('startDate').value = formatDate(dateRange.min);
                document.getElementById('endDate').value = formatDate(dateRange.max);
                updateDashboard();
            }
        }
        
        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        
        // Data filtering
        function filterDataByDateRange(data, dateField, startDate, endDate) {
            if (!startDate || !endDate || !Array.isArray(data)) return data;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            return data.filter(row => {
                const dateValue = row[dateField];
                if (!dateValue) return false;
                
                let date;
                if (typeof dateValue === 'number' || (typeof dateValue === 'string' && /^\d{10,12}$/.test(dateValue))) {
                    const str = dateValue.toString();
                    date = new Date(str.substr(0,4), parseInt(str.substr(4,2))-1, str.substr(6,2));
                } else {
                    date = new Date(dateValue);
                }
                
                return date >= start && date <= end;
            });
        }
        
        // Calculation helpers
        function formatNumber(num) {
            num = parseFloat(num) || 0;
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }
        
        function formatPercentage(num) {
            return (parseFloat(num) || 0).toFixed(1) + '%';
        }
        
        // Dashboard generation
        function updateDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const compareType = document.getElementById('compareType').value;
            
            if (!startDate || !endDate) {
                showError('Please select a date range');
                return;
            }
            
            currentDateRange = { start: startDate, end: endDate };
            updateDateRangeInfo(startDate, endDate, compareType);
            
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `<div class="loading"><div class="loading-spinner"></div><p>Generating dashboard...</p></div>`;
            
            setTimeout(() => generateDashboard(startDate, endDate, compareType), 300);
        }
        
        function updateDateRangeInfo(startDate, endDate, compareType) {
            const infoDiv = document.getElementById('dateRangeInfo');
            const textSpan = document.getElementById('dateRangeText');
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let text = `Showing ${daysDiff} days: ${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
            if (compareType === 'previous') text += ` (comparing with previous ${daysDiff} days)`;
            else if (compareType === 'year') text += ' (comparing with same period last year)';
            
            textSpan.textContent = text;
            infoDiv.style.display = 'flex';
        }
        
        function generateDashboard(startDate, endDate, compareType) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            
            if (Object.keys(processedData).length === 0) {
                dashboard.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìä</div><h3>No Data Connected</h3><p>Please connect to your Google Sheets to see your marketing analytics data.</p></div>`;
                return;
            }
            
            generateWebAnalytics(dashboard, startDate, endDate, compareType);
            generateSocialAnalytics(dashboard, startDate, endDate, compareType);
            generateEmailAnalytics(dashboard, startDate, endDate, compareType);
            generateYouTubeAnalytics(dashboard, startDate, endDate, compareType);
        }
        
        // Web Analytics Section
        function generateWebAnalytics(dashboard, startDate, endDate, compareType) {
            if (!processedData['GA_Demographics.csv'] && !processedData['GA_Traffic_Acquisition.csv']) return;
            
            dashboard.innerHTML += `<div class="section-header">üåê Web Analytics</div>`;
            const grid = document.createElement('div');
            grid.className = 'dashboard-grid';
            
            if (processedData['GA_Demographics.csv']) grid.appendChild(createDemographicsCard(startDate, endDate, compareType));
            if (processedData['GA_Traffic_Acquisition.csv']) grid.appendChild(createTrafficSourcesCard(startDate, endDate, compareType));
            if (processedData['GA_Pages_And_Screens.csv']) grid.appendChild(createTopPagesCard(startDate, endDate, compareType));
            if (processedData['GA_UTMs.csv']) grid.appendChild(createCampaignPerformanceCard(startDate, endDate, compareType));
            
            dashboard.appendChild(grid);
        }
        
        function createDemographicsCard(startDate, endDate, compareType) {
            const card = createCard('Demographics & User Insights', 'üë•');
            const currentData = filterDataByDateRange(processedData['GA_Demographics.csv'], 'Date + hour (YYYYMMDDHH)', startDate, endDate);
            const metrics = calculateWebMetrics(currentData);
            
            card.appendChild(createMetricsGrid([
                { label: 'Total Users', value: formatNumber(metrics.totalUsers) },
                { label: 'New Users', value: formatNumber(metrics.newUsers) },
                { label: 'Sessions', value: formatNumber(metrics.sessions) },
                { label: 'Avg. Engagement', value: formatPercentage(metrics.avgEngagement) },
                { label: 'Avg. Session Time', value: metrics.avgSessionTime + 's' },
                { label: 'Engaged Sessions', value: formatNumber(metrics.engagedSessions) }
            ]));
            
            const locationData = getTopLocations(currentData);
            if (locationData.length > 0) {
                card.appendChild(createTable(
                    ['Country', 'City', 'Users', 'Sessions'],
                    locationData.map(loc => [loc.country, loc.city, formatNumber(loc.users), formatNumber(loc.sessions)])
                ));
            }
            return card;
        }

        function createTrafficSourcesCard(startDate, endDate, compareType) {
            const card = createCard('Traffic Sources & Channels', 'üöÄ', true);
            const currentData = filterDataByDateRange(processedData['GA_Traffic_Acquisition.csv'], 'Date + hour (YYYYMMDDHH)', startDate, endDate);
            const sourceData = aggregateTrafficSources(currentData);
            
            if (sourceData.length > 0) {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                const canvas = document.createElement('canvas');
                chartContainer.appendChild(canvas);
                card.appendChild(chartContainer);
                createTrafficChart(canvas, sourceData);
            }
            
            card.appendChild(createTable(
                ['Source/Medium', 'Sessions', 'Engaged Sessions', 'Engagement Rate'],
                sourceData.slice(0, 10).map(source => [
                    source.source,
                    formatNumber(source.sessions),
                    formatNumber(source.engagedSessions),
                    formatPercentage(source.engagementRate)
                ])
            ));
            return card;
        }
        
        function createTopPagesCard(startDate, endDate, compareType) {
            const card = createCard('Top Landing Pages', 'üìÑ', true);
            const currentData = filterDataByDateRange(processedData['GA_Pages_And_Screens.csv'], 'Date + hour (YYYYMMDDHH)', startDate, endDate);
            const pageData = aggregatePageData(currentData);
            
            const tabContainer = createTabs(['By Views', 'By Users', 'By Engagement Time'], (tabIndex) => {
                const sortedData = [...pageData];
                if (tabIndex === 0) sortedData.sort((a, b) => b.views - a.views);
                else if (tabIndex === 1) sortedData.sort((a, b) => b.users - a.users);
                else sortedData.sort((a, b) => b.engagementTime - a.engagementTime);
                
                updateTableData(card.querySelector('table'), sortedData.slice(0, 10).map(page => [
                    (page.path || '').substring(0, 50) + ((page.path || '').length > 50 ? '...' : ''),
                    formatNumber(page.views),
                    formatNumber(page.users),
                    Math.round(page.engagementTime / 60) + ' min'
                ]));
            });
            card.appendChild(tabContainer);
            
            const sortedByViews = [...pageData].sort((a, b) => b.views - a.views);
            card.appendChild(createTable(
                ['Page Path', 'Views', 'Users', 'Total Engagement'],
                sortedByViews.slice(0, 10).map(page => [
                    (page.path || '').substring(0, 50) + ((page.path || '').length > 50 ? '...' : ''),
                    formatNumber(page.views),
                    formatNumber(page.users),
                    Math.round(page.engagementTime / 60) + ' min'
                ])
            ));
            return card;
        }
        
        function createCampaignPerformanceCard(startDate, endDate, compareType) {
            const card = createCard('Campaign Performance (UTM)', 'üéØ', true);
            const currentData = filterDataByDateRange(processedData['GA_UTMs.csv'], 'Date + hour (YYYYMMDDHH)', startDate, endDate);
            
            if (!currentData || currentData.length === 0 || !currentData[0]['Manual campaign name']) {
                card.innerHTML += `<div class="info-box error"><h4>‚ö†Ô∏è UTM Campaign Data Issue</h4><p>The GA_UTMs sheet appears to be incomplete or malformed. Ensure it contains campaign tracking data with columns like 'Manual campaign name', 'Sessions', etc.</p><p style="font-size: 0.875rem; margin-top: 10px;"><strong>To fix:</strong> Re-export from GA4 ‚Üí Reports ‚Üí Acquisition ‚Üí Campaigns ‚Üí Export with UTM parameters included.</p></div>`;
                return card;
            }
            
            const campaignData = aggregateCampaignData(currentData);
            card.appendChild(createTable(
                ['Campaign', 'Source/Medium', 'Sessions', 'Engaged Sessions', 'Key Events'],
                campaignData.slice(0, 10).map(c => [c.name, c.source, formatNumber(c.sessions), formatNumber(c.engagedSessions), formatNumber(c.keyEvents)])
            ));
            return card;
        }

        // Social Analytics Section
        function generateSocialAnalytics(dashboard, startDate, endDate, compareType) {
            const hasFacebook = Object.keys(processedData).some(k => k.startsWith('FB_'));
            const hasInstagram = Object.keys(processedData).some(k => k.startsWith('IG_'));
            if (!hasFacebook && !hasInstagram) return;

            dashboard.innerHTML += `<div class="section-header">üì± Social Media Analytics</div>`;
            const grid = document.createElement('div');
            grid.className = 'dashboard-grid';

            if (processedData['FB_Audience.csv'] || processedData['IG_Audience.csv']) grid.appendChild(createSocialDemographicsCard());
            if (hasFacebook) grid.appendChild(createFacebookMetricsCard(startDate, endDate, compareType));
            if (hasInstagram) grid.appendChild(createInstagramMetricsCard(startDate, endDate, compareType));
            grid.appendChild(createTopSocialPostsCard(startDate, endDate));
            
            dashboard.appendChild(grid);
        }

        function createSocialDemographicsCard() {
            const card = createCard('Social Media Demographics', 'üë•', true);
            const platforms = [];
            if (processedData['FB_Audience.csv']) platforms.push('Facebook');
            if (processedData['IG_Audience.csv']) platforms.push('Instagram');

            if (platforms.length === 0) {
                card.innerHTML += `<div class="info-box info"><p>No demographic data available. Add FB_Audience.csv or IG_Audience.csv to see demographics.</p></div>`;
                return card;
            }
            
            const tabContainer = createTabs(platforms, (tabIndex) => {
                const platform = platforms[tabIndex];
                displayAudienceData(card.querySelector('#socialDemographicsContent'), platform);
            });
            card.appendChild(tabContainer);
            
            const contentDiv = document.createElement('div');
            contentDiv.id = 'socialDemographicsContent';
            card.appendChild(contentDiv);
            
            displayAudienceData(contentDiv, platforms[0]);
            return card;
        }

        function displayAudienceData(container, platform) {
            container.innerHTML = '';
            const fileName = platform === 'Facebook' ? 'FB_Audience.csv' : 'IG_Audience.csv';
            const data = processedData[fileName];
            
            if (!data || !data.ageGender) {
                container.innerHTML = '<p style="text-align: center; color: var(--duke-gray);">No demographic data available</p>';
                return;
            }
            
            if (data.ageGender && data.ageGender.length > 0) {
                const ageSection = document.createElement('div');
                ageSection.innerHTML = '<h4 style="margin: 20px 0 15px; color: var(--duke-navy);">Age & Gender Distribution</h4>';
                ageSection.appendChild(createTable(['Age Group', 'Women', 'Men'], data.ageGender.map(row => [row['Age'] || row['age'], row['Women'] || '0%', row['Men'] || '0%'])));
                container.appendChild(ageSection);
            }
            
            if (data.topCities && data.topCities.length > 0) {
                const citiesSection = document.createElement('div');
                citiesSection.innerHTML = '<h4 style="margin: 20px 0 15px; color: var(--duke-navy);">Top Cities</h4>';
                citiesSection.appendChild(createTable(['City', 'Percentage'], data.topCities.slice(0, 10).map(row => [row['City'] || row['city'], row['Percentage'] || '0%'])));
                container.appendChild(citiesSection);
            }
        }
        
        function createFacebookMetricsCard(startDate, endDate, compareType) {
            const card = createCard('Facebook Performance', 'üìò');
            const metrics = calculateSocialMetrics('FB', startDate, endDate);
            
            card.appendChild(createMetricsGrid([
                { label: 'Total Reach', value: formatNumber(metrics.reach) },
                { label: 'Interactions', value: formatNumber(metrics.interactions) },
                { label: 'New Followers', value: formatNumber(metrics.follows) },
                { label: 'Profile Views', value: formatNumber(metrics.views) },
                { label: 'Link Clicks', value: formatNumber(metrics.linkClicks) },
                { label: 'Page Visits', value: formatNumber(metrics.visits) }
            ]));

            card.innerHTML += `<div class="info-box info"><h4>üìà Page Rank & Quality Score</h4><p>Facebook Page Rank is not available in standard data exports. To check your page's ranking, go to Meta Business Suite ‚Üí Insights ‚Üí Overview and look for "Page Quality" or "Distribution Score".</p></div>`;
            return card;
        }

        function createInstagramMetricsCard(startDate, endDate, compareType) {
            const card = createCard('Instagram Performance', 'üì∑');
            const metrics = calculateSocialMetrics('IG', startDate, endDate);
            
            card.appendChild(createMetricsGrid([
                { label: 'Total Reach', value: formatNumber(metrics.reach) },
                { label: 'Interactions', value: formatNumber(metrics.interactions) },
                { label: 'New Followers', value: formatNumber(metrics.follows) },
                { label: 'Profile Views', value: formatNumber(metrics.views) },
                { label: 'Link Clicks', value: formatNumber(metrics.linkClicks) },
                { label: 'Profile Visits', value: formatNumber(metrics.visits) }
            ]));
            return card;
        }

        function createTopSocialPostsCard(startDate, endDate) {
            const card = createCard('Top Social Media Posts', 'üèÜ', true);
            card.innerHTML += `<div class="info-box warning"><h4>üìä Post Data Required</h4><p>To see top performing posts, please create Google Sheets named <strong>FB_Posts.csv</strong> and <strong>IG_Posts.csv</strong> with post-level data from Meta Business Suite.</p></div>`;
            return card;
        }

        // Email Analytics Section
        function generateEmailAnalytics(dashboard, startDate, endDate, compareType) {
            if (!processedData['Email_Campaign_Performance.csv']) return;

            dashboard.innerHTML += `<div class="section-header">üìß Email Marketing Analytics</div>`;
            const grid = document.createElement('div');
            grid.className = 'dashboard-grid';
            
            grid.appendChild(createEmailOverviewCard(startDate, endDate, compareType));
            grid.appendChild(createTopEmailCampaignsCard(startDate, endDate));
            grid.appendChild(createSubscriberInsightsCard(startDate, endDate));
            
            dashboard.appendChild(grid);
        }

        function createEmailOverviewCard(startDate, endDate, compareType) {
            const card = createCard('Email Marketing Overview', 'üìä');
            const emailData = processedData['Email_Campaign_Performance.csv'] || [];
            const metrics = calculateEmailMetrics(emailData);
            
            card.appendChild(createMetricsGrid([
                { label: 'Total Campaigns', value: emailData.length },
                { label: 'Total Sent', value: formatNumber(metrics.totalSent) },
                { label: 'Avg Open Rate', value: formatPercentage(metrics.avgOpenRate) },
                { label: 'Avg Click Rate', value: formatPercentage(metrics.avgClickRate) },
                { label: 'Total Opens', value: formatNumber(metrics.totalOpens) },
                { label: 'Total Clicks', value: formatNumber(metrics.totalClicks) }
            ]));
            return card;
        }

        function createTopEmailCampaignsCard(startDate, endDate) {
            const card = createCard('Top Email Campaigns', 'üèÜ', true);
            const emailData = processedData['Email_Campaign_Performance.csv'] || [];

            const tabContainer = createTabs(['By Open Rate', 'By Click Rate', 'By Total Clicks'], (tabIndex) => {
                let sortedData = [...emailData];
                const getVal = (row, key) => parseFloat(String(row[key] || '0').replace(/[^0-9.]/g, ''));
                
                if (tabIndex === 0) sortedData.sort((a, b) => getVal(b, 'Email open rate (MPP excluded)') - getVal(a, 'Email open rate (MPP excluded)'));
                else if (tabIndex === 1) sortedData.sort((a, b) => getVal(b, 'Email click rate') - getVal(a, 'Email click rate'));
                else sortedData.sort((a, b) => getVal(b, 'Email clicked') - getVal(a, 'Email clicked'));
                
                updateTableData(card.querySelector('table'), sortedData.slice(0, 10).map(c => [
                    c.Campaign, c['Email open rate (MPP excluded)'], c['Email click rate'], 
                    formatNumber(getVal(c, 'Email clicked') * 1.3), formatNumber(getVal(c, 'Emails sent'))
                ]));
            });
            card.appendChild(tabContainer);
            
            const sortedByOpen = [...emailData].sort((a, b) => parseFloat(a['Email open rate (MPP excluded)'] || 0) - parseFloat(b['Email open rate (MPP excluded)'] || 0)).reverse();
            card.appendChild(createTable(['Campaign', 'Open Rate', 'Click Rate', 'Total Clicks*', 'Sent'], sortedByOpen.slice(0, 10).map(c => [
                c.Campaign, c['Email open rate (MPP excluded)'], c['Email click rate'], 
                formatNumber((parseFloat(String(c['Email clicked'] || 0).replace(/,/g, '')) || 0) * 1.3), 
                formatNumber(parseFloat(String(c['Emails sent'] || 0).replace(/,/g, '')))
            ])));
            card.innerHTML += `<p style="margin: 10px 0 0; color: #666; font-size: 0.75rem; font-style: italic;">* Total clicks estimated from unique clicks (multiple clicks per user estimated at 30%)</p>`;
            return card;
        }
        
        function createSubscriberInsightsCard(startDate, endDate) {
            const card = createCard('Subscriber Insights & Engagement', 'üë§', true);
            const emailData = processedData['Email_Campaign_Performance.csv'] || [];
            const metrics = calculateSubscriberMetrics(emailData);

            card.appendChild(createMetricsGrid([
                { label: 'Est. Subscribers', value: formatNumber(metrics.avgEmailsSent) },
                { label: 'Never Opened', value: formatPercentage(metrics.neverOpenedRate) },
                { label: 'Opened, No Click', value: formatPercentage(metrics.openedNoClickRate) },
                { label: 'Active Clickers', value: formatPercentage(metrics.activeClickerRate) },
                { label: 'Unsubscribe Rate', value: formatPercentage(metrics.avgUnsubscribeRate) },
                { label: 'Bounce Rate', value: formatPercentage(metrics.avgBounceRate) }
            ]));

            const funnelContainer = document.createElement('div');
            funnelContainer.className = 'chart-container';
            funnelContainer.style.height = '250px';
            const canvas = document.createElement('canvas');
            funnelContainer.appendChild(canvas);
            card.appendChild(funnelContainer);
            createEngagementFunnel(canvas, metrics);

            card.innerHTML += `<div class="info-box info"><h4>üìä Subscriber Demographics</h4><p>Detailed subscriber demographics are not included in campaign exports. Check your email platform's audience insights for this data.</p></div>`;
            card.innerHTML += `<div class="info-box warning"><h4>üîó Best Performing Links</h4><p>Individual link performance is not in this export. Use UTM parameters and view in Google Analytics or check your email platform's reports.</p></div>`;
            return card;
        }

        // YouTube Analytics Section
        function generateYouTubeAnalytics(dashboard, startDate, endDate, compareType) {
            if (!processedData['YouTube_Content.csv']) return;
            
            dashboard.innerHTML += `<div class="section-header">üé• YouTube Analytics</div>`;
            const grid = document.createElement('div');
            grid.className = 'dashboard-grid';
            
            grid.appendChild(createYouTubeOverviewCard(startDate, endDate, compareType));
            if (processedData['YouTube_Age.csv'] || processedData['YouTube_Gender.csv']) grid.appendChild(createYouTubeDemographicsCard());
            grid.appendChild(createTopVideosCard(startDate, endDate));
            if (processedData['YouTube_Subscription_Status.csv']) grid.appendChild(createSubscriberAnalysisCard());
            
            dashboard.appendChild(grid);
        }

        function createYouTubeOverviewCard(startDate, endDate, compareType) {
            const card = createCard('YouTube Channel Overview', 'üìä');
            const contentData = filterDataByDateRange(processedData['YouTube_Content.csv'], 'Video publish time', startDate, endDate);
            const metrics = calculateYouTubeMetrics(contentData);
            
            card.appendChild(createMetricsGrid([
                { label: 'Total Views', value: formatNumber(metrics.totalViews) },
                { label: 'Watch Time (hrs)', value: formatNumber(Math.round(metrics.totalWatchTime)) },
                { label: 'New Subscribers', value: formatNumber(metrics.totalSubscribers) },
                { label: 'Videos Published', value: contentData.length },
                { label: 'Avg CTR', value: formatPercentage(metrics.avgCTR) },
                { label: 'Total Impressions', value: formatNumber(metrics.totalImpressions) }
            ]));
            return card;
        }

        function createYouTubeDemographicsCard() {
            const card = createCard('YouTube Audience Demographics', 'üë•', true);

            if (processedData['YouTube_Age.csv']) {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.style.height = '300px';
                const canvas = document.createElement('canvas');
                chartContainer.appendChild(canvas);
                card.appendChild(chartContainer);
                createYouTubeAgeChart(canvas, processedData['YouTube_Age.csv']);
            }
            
            if (processedData['YouTube_Gender.csv']) {
                const genderGrid = document.createElement('div');
                genderGrid.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;';
                processedData['YouTube_Gender.csv'].forEach(row => {
                    genderGrid.innerHTML += `<div class="metric-card"><div class="metric-value">${row['Views (%)'] || 0}%</div><div class="metric-label">${row['Viewer gender']}</div></div>`;
                });
                card.appendChild(genderGrid);
            }

            if (processedData['YouTube_Geography.csv']) {
                const geoSection = document.createElement('div');
                geoSection.innerHTML = '<h4 style="margin: 20px 0 15px; color: var(--duke-navy);">Top Countries</h4>';
                geoSection.appendChild(createTable(['Country', 'Views', 'Watch Time (hrs)', 'Avg Duration'], processedData['YouTube_Geography.csv'].slice(0, 10).map(row => [
                    row['Geography'], formatNumber(row['Views']), formatNumber(Math.round(row['Watch time (hours)'])), row['Average view duration']
                ])));
                card.appendChild(geoSection);
            }
            return card;
        }

        function createTopVideosCard(startDate, endDate) {
            const card = createCard('Top Performing Videos', 'üèÜ', true);
            let contentData = processedData['YouTube_Content.csv'] || [];
            if (startDate && endDate) contentData = filterDataByDateRange(contentData, 'Video publish time', startDate, endDate);
            
            const tabContainer = createTabs(['By Views', 'By Watch Time', 'By Subscribers', 'By CTR'], (tabIndex) => {
                let sortedData = [...contentData];
                const getVal = (row, key) => parseFloat(row[key] || 0);

                if (tabIndex === 0) sortedData.sort((a, b) => getVal(b, 'Views') - getVal(a, 'Views'));
                else if (tabIndex === 1) sortedData.sort((a, b) => getVal(b, 'Watch time (hours)') - getVal(a, 'Watch time (hours)'));
                else if (tabIndex === 2) sortedData.sort((a, b) => getVal(b, 'Subscribers') - getVal(a, 'Subscribers'));
                else sortedData.sort((a, b) => getVal(b, 'Impressions click-through rate (%)') - getVal(a, 'Impressions click-through rate (%)'));
                
                updateTableData(card.querySelector('table'), sortedData.slice(0, 10).map(v => [
                    (v['Video title'] || '').substring(0, 50), formatNumber(v.Views), formatNumber(Math.round(v['Watch time (hours)'])),
                    '+' + formatNumber(v.Subscribers), formatPercentage(v['Impressions click-through rate (%)'])
                ]));
            });
            card.appendChild(tabContainer);
            
            const sortedByViews = [...contentData].sort((a, b) => (b.Views || 0) - (a.Views || 0));
            card.appendChild(createTable(['Video Title', 'Views', 'Watch Time (hrs)', 'New Subscribers', 'CTR'], sortedByViews.slice(0, 10).map(v => [
                (v['Video title'] || '').substring(0, 50), formatNumber(v.Views), formatNumber(Math.round(v['Watch time (hours)'])),
                '+' + formatNumber(v.Subscribers), formatPercentage(v['Impressions click-through rate (%)'])
            ])));
            return card;
        }
        
        function createSubscriberAnalysisCard() {
            const card = createCard('Viewer Analysis: Subscribers vs Non-Subscribers', 'üë§');
            const subData = processedData['YouTube_Subscription_Status.csv'] || [];
            
            const subscribedData = subData.find(r => r['Subscription status'] === 'Subscribed') || {};
            const notSubscribedData = subData.find(r => r['Subscription status'] === 'Not subscribed') || {};
            
            const totalViews = (parseFloat(subscribedData.Views) || 0) + (parseFloat(notSubscribedData.Views) || 0);
            const subscribedPercentage = totalViews > 0 ? ((parseFloat(subscribedData.Views) || 0) / totalViews) * 100 : 0;
            const notSubscribedPercentage = totalViews > 0 ? ((parseFloat(notSubscribedData.Views) || 0) / totalViews) * 100 : 0;
            
            card.appendChild(createMetricsGrid([
                { label: 'Subscriber Views', value: formatPercentage(subscribedPercentage) },
                { label: 'Non-Sub Views', value: formatPercentage(notSubscribedPercentage) },
                { label: 'Sub Watch Time', value: formatNumber(Math.round(subscribedData['Watch time (hours)'])) + ' hrs' },
                { label: 'Non-Sub Watch Time', value: formatNumber(Math.round(notSubscribedData['Watch time (hours)'])) + ' hrs' }
            ]));

            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '300px';
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            card.appendChild(chartContainer);
            createSubscriberChart(canvas, subscribedData, notSubscribedData);
            return card;
        }

        // Calculation functions
        function calculateWebMetrics(data) {
            const metrics = { totalUsers: 0, newUsers: 0, sessions: 0, engagedSessions: 0, avgEngagement: 0, avgSessionTime: 0 };
            data.forEach(row => {
                metrics.totalUsers += parseInt(row['Total users'] || 0);
                metrics.newUsers += parseInt(row['New users'] || 0);
                metrics.engagedSessions += parseInt(row['Engaged sessions'] || 0);
                metrics.sessions += 1; // Assuming one row per session
            });
            if (data.length > 0) {
                metrics.avgEngagement = data.reduce((sum, row) => sum + (parseFloat(row['Engagement rate']) || 0), 0) / data.length * 100;
                metrics.avgSessionTime = Math.round(data.reduce((sum, row) => sum + (parseFloat(row['Average engagement time per session']) || 0), 0) / data.length);
            }
            return metrics;
        }

        function getTopLocations(data) {
            const map = {};
            data.forEach(row => {
                const key = `${row.Country || 'Unknown'}_${row.City || 'Unknown'}`;
                if (!map[key]) map[key] = { country: row.Country || 'Unknown', city: row.City || 'Unknown', users: 0, sessions: 0 };
                map[key].users += parseInt(row['Total users'] || 0);
                map[key].sessions += 1;
            });
            return Object.values(map).sort((a, b) => b.users - a.users).slice(0, 5);
        }

        function aggregateTrafficSources(data) {
            const map = {};
            data.forEach(row => {
                const source = row['Session source / medium'] || 'Unknown';
                if (!map[source]) map[source] = { source, sessions: 0, engagedSessions: 0 };
                map[source].sessions++;
                map[source].engagedSessions += parseInt(row['Engaged sessions'] || 0);
            });
            return Object.values(map).map(s => ({ ...s, engagementRate: s.sessions > 0 ? (s.engagedSessions / s.sessions) * 100 : 0 })).sort((a,b) => b.sessions - a.sessions);
        }

        function aggregatePageData(data) {
            const map = {};
            data.forEach(row => {
                const path = row['Page path and screen class'] || 'Unknown';
                if (!map[path]) map[path] = { path, views: 0, users: 0, engagementTime: 0 };
                map[path].views += parseInt(row.Views || 0);
                map[path].users += parseInt(row['Active users'] || 0);
                map[path].engagementTime += (parseInt(row['Engaged sessions'] || 0)) * (parseFloat(row['Average engagement time per session']) || 45);
            });
            return Object.values(map);
        }

        function aggregateCampaignData(data) {
            const map = {};
            data.forEach(row => {
                const key = `${row['Manual campaign name']}_${row['Manual source / medium']}`;
                if (!map[key]) map[key] = { name: row['Manual campaign name'], source: row['Manual source / medium'], sessions: 0, engagedSessions: 0, keyEvents: 0 };
                map[key].sessions += parseInt(row.Sessions || 0);
                map[key].engagedSessions += parseInt(row['Engaged sessions'] || 0);
                map[key].keyEvents += parseFloat(row['Key events'] || 0);
            });
            return Object.values(map).sort((a,b) => b.sessions - a.sessions);
        }

        function calculateSocialMetrics(platform, startDate, endDate) {
            const metrics = { reach: 0, interactions: 0, follows: 0, views: 0, linkClicks: 0, visits: 0 };
            const files = ['Reach', 'Interactions', 'Follows', 'Views', 'Link_Clicks', 'Visits'];
            files.forEach(type => {
                const fileName = `${platform}_${type}.csv`;
                if (processedData[fileName]) {
                    const data = filterDataByDateRange(processedData[fileName], 'Date', startDate, endDate);
                    metrics[type.toLowerCase().replace('_', '')] = data.reduce((sum, row) => sum + (parseInt(row.Primary) || 0), 0);
                }
            });
            return metrics;
        }

        function calculateEmailMetrics(data) {
            const metrics = { totalSent: 0, totalDelivered: 0, totalOpens: 0, totalClicks: 0 };
            data.forEach(c => {
                metrics.totalSent += parseInt(String(c['Emails sent'] || 0).replace(/,/g, ''));
                metrics.totalDelivered += parseInt(String(c['Email deliveries'] || 0).replace(/,/g, ''));
                metrics.totalOpens += parseInt(String(c['Email opened (MPP excluded)'] || 0).replace(/,/g, ''));
                metrics.totalClicks += parseInt(String(c['Email clicked'] || 0).replace(/,/g, ''));
            });
            metrics.avgOpenRate = metrics.totalDelivered > 0 ? (metrics.totalOpens / metrics.totalDelivered) * 100 : 0;
            metrics.avgClickRate = metrics.totalDelivered > 0 ? (metrics.totalClicks / metrics.totalDelivered) * 100 : 0;
            return metrics;
        }

        function calculateSubscriberMetrics(data) {
            const metrics = { avgEmailsSent: 0, neverOpenedRate: 0, openedNoClickRate: 0, activeClickerRate: 0, avgUnsubscribeRate: 0, avgBounceRate: 0 };
            let totalSent = 0, totalDelivered = 0, totalOpened = 0, totalClicked = 0, totalBounces = 0, totalUnsubscribes = 0;
            data.forEach(c => {
                totalSent += parseInt(String(c['Emails sent'] || 0).replace(/,/g, ''));
                totalDelivered += parseInt(String(c['Email deliveries'] || 0).replace(/,/g, ''));
                totalOpened += parseInt(String(c['Email opened (MPP excluded)'] || 0).replace(/,/g, ''));
                totalClicked += parseInt(String(c['Email clicked'] || 0).replace(/,/g, ''));
                totalBounces += parseInt(c['Email bounces'] || 0);
                totalUnsubscribes += parseInt(c['Email unsubscribes'] || 0);
            });
            if (data.length > 0) metrics.avgEmailsSent = totalSent / data.length;
            if (totalDelivered > 0) {
                metrics.neverOpenedRate = ((totalDelivered - totalOpened) / totalDelivered) * 100;
                metrics.openedNoClickRate = ((totalOpened - totalClicked) / totalDelivered) * 100;
                metrics.activeClickerRate = (totalClicked / totalDelivered) * 100;
            }
            if (totalSent > 0) {
                metrics.avgUnsubscribeRate = (totalUnsubscribes / totalSent) * 100;
                metrics.avgBounceRate = (totalBounces / totalSent) * 100;
            }
            return metrics;
        }

        function calculateYouTubeMetrics(data) {
            return {
                totalViews: data.reduce((s, v) => s + (parseFloat(v.Views) || 0), 0),
                totalWatchTime: data.reduce((s, v) => s + (parseFloat(v['Watch time (hours)']) || 0), 0),
                totalSubscribers: data.reduce((s, v) => s + (parseFloat(v.Subscribers) || 0), 0),
                totalImpressions: data.reduce((s, v) => s + (parseFloat(v.Impressions) || 0), 0),
                avgCTR: data.length > 0 ? data.reduce((s, v) => s + (parseFloat(v['Impressions click-through rate (%)']) || 0), 0) / data.length : 0
            };
        }
        
        // UI Helper functions
        function createCard(title, icon, fullWidth = false) {
            const card = document.createElement('div');
            card.className = fullWidth ? 'card full-width' : 'card';
            card.innerHTML = `<div class="card-header"><div class="card-title">${icon ? `<span class="card-icon">${icon}</span>` : ''} ${title}</div></div>`;
            return card;
        }
        
        function createMetricsGrid(metrics) {
            const grid = document.createElement('div');
            grid.className = 'metrics-grid';
            metrics.forEach(metric => {
                grid.innerHTML += `<div class="metric-card"><div class="metric-value">${metric.value}</div><div class="metric-label">${metric.label}</div></div>`;
            });
            return grid;
        }
        
        function createTable(headers, rows) {
            const container = document.createElement('div');
            container.className = 'table-container';
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
            container.appendChild(table);
            return container;
        }
        
        function updateTableData(table, rows) {
            if (!table) return;
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
        }
        
        function createTabs(labels, onTabChange) {
            const container = document.createElement('div');
            container.className = 'tab-container';
            labels.forEach((label, index) => {
                const tab = document.createElement('button');
                tab.className = 'tab-button' + (index === 0 ? ' active' : '');
                tab.textContent = label;
                tab.onclick = () => {
                    container.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    onTabChange(index);
                };
                container.appendChild(tab);
            });
            return container;
        }
        
        // Chart creation functions
        function createTrafficChart(canvas, sourceData) {
            new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: sourceData.slice(0, 6).map(s => s.source),
                    datasets: [{ data: sourceData.slice(0, 6).map(s => s.sessions), backgroundColor: ['#012169', '#00539B', '#5B9BD5', '#666666', '#E5E5E5', '#262626'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }, title: { display: true, text: 'Traffic Distribution by Source', font: { size: 16, weight: 'bold' }, padding: 20 } } }
            });
        }
        
        function createEngagementFunnel(canvas, metrics) {
            new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Total Recipients', 'Opened Email', 'Clicked Links'],
                    datasets: [{ label: 'Email Engagement Funnel', data: [100, 100 - metrics.neverOpenedRate, metrics.activeClickerRate], backgroundColor: ['#012169', '#00539B', '#5B9BD5'], borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }, plugins: { legend: { display: false } } }
            });
        }
        
        function createYouTubeAgeChart(canvas, ageData) {
            new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ageData.map(row => row['Viewer age']),
                    datasets: [{ label: 'Views by Age Group (%)', data: ageData.map(row => parseFloat(row['Views (%)']) || 0), backgroundColor: '#00539B', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => v + '%' } } }, plugins: { legend: { display: false } } }
            });
        }
        
        function createSubscriberChart(canvas, subscribedData, notSubscribedData) {
            new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Subscribers', 'Non-Subscribers'],
                    datasets: [{ data: [parseFloat(subscribedData.Views) || 0, parseFloat(notSubscribedData.Views) || 0], backgroundColor: ['#00539B', '#E5E5E5'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }, title: { display: true, text: 'Views by Subscription Status', font: { size: 16, weight: 'bold' }, padding: 20 } } }
            });
        }
        
        function showError(message) {
            const dashboard = document.getElementById('dashboard');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            dashboard.insertBefore(errorDiv, dashboard.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateControls();
            const savedFolderId = localStorage.getItem('dukeChapel_folderId');
            const savedApiKey = localStorage.getItem('dukeChapel_apiKey');
            if (savedFolderId) document.getElementById('folderId').value = savedFolderId;
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedFolderId && savedApiKey) {
                setTimeout(connectToSheets, 500);
            }
        });
    </script>
</body>
</html>