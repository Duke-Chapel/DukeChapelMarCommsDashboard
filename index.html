<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --duke-navy: #012169;
            --duke-blue: #00539B;
            --duke-light-blue: #5B9BD5;
            --duke-gray: #666666;
            --duke-light-gray: #E5E5E5;
            --duke-white: #FFFFFF;
            --duke-black: #262626;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f9; margin: 0; padding: 0; color: var(--duke-black); }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--duke-navy); color: var(--duke-white); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; }
        .controls { background-color: var(--duke-white); padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.8rem; margin-bottom: 5px; color: var(--duke-gray); font-weight: 500; }
        input[type="date"], button { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-family: 'Inter', sans-serif; }
        button { background-color: var(--duke-blue); color: white; cursor: pointer; transition: background-color 0.3s; border: none; padding: 10px 15px; align-self: flex-end; }
        button:hover { background-color: var(--duke-light-blue); }
        .tab-bar { display: flex; border-bottom: 2px solid var(--duke-light-gray); margin-bottom: 20px; }
        .tab-button { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 1.1rem; font-weight: 600; color: var(--duke-gray); border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-button.active { color: var(--duke-navy); border-bottom-color: var(--duke-navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background-color: var(--duke-white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0 0 15px 0; color: var(--duke-navy); }
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-label { font-size: 0.9rem; color: var(--duke-gray); margin: 0 0 5px 0; }
        .kpi-value { font-size: 1.75rem; font-weight: bold; color: var(--duke-blue); margin: 0; }
        .chart-container { position: relative; flex-grow: 1; min-height: 300px; }
        .table-container { overflow-x: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--duke-light-gray); }
        th { background-color: #f8f9fa; font-weight: 600; }
        .loader-container { text-align: center; padding: 40px; }
        .loader { font-size: 1.2rem; margin-bottom: 20px; }
        #status-panel { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: left; font-family: monospace; max-width: 800px; margin: 20px auto; line-height: 1.6; }
        #status-panel h3 { margin-top: 0; font-family: 'Inter', sans-serif; color: var(--duke-navy) }
        #status-panel .status-found { color: #198754; font-weight: bold; }
        #status-panel .status-missing { color: #dc3545; font-weight: bold; }
        #status-panel ul { list-style-type: none; padding-left: 0; }
    </style>
</head>
<body>
    <header><h1>Marketing Analytics Dashboard</h1></header>

    <div class="container">
        <div class="controls">
             <div class="control-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="control-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
            </div>
            <button id="filterButton">Filter</button>
        </div>

        <div class="tab-bar">
            <button class="tab-button active" onclick="openTab('web')">Web</button>
            <button class="tab-button" onclick="openTab('social')">Social</button>
            <button class="tab-button" onclick="openTab('email')">Email</button>
            <button class="tab-button" onclick="openTab('youtube')">YouTube</button>
        </div>
        
        <div id="loader-container" class="loader-container">
            <div id="loader" class="loader">Connecting to Google Drive...</div>
            <div id="status-panel" style="display: none;">
                <h3>API Connection Status</h3>
                <div id="status-message"></div>
                <ul id="status-list"></ul>
            </div>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div id="web" class="tab-content active">
                <div class="dashboard">
                    <div class="card"><h2 class="card-title">Web KPIs</h2><div class="kpi-container"><div class="kpi"><p class="kpi-label">Total Users</p><p class="kpi-value" id="totalUsers">0</p></div><div class="kpi"><p class="kpi-label">Total Sessions</p><p class="kpi-value" id="totalSessions">0</p></div></div></div>
                    <div class="card"><h2 class="card-title">Sessions by Source</h2><div class="chart-container"><canvas id="trafficSourcesChart"></canvas></div></div>
                    <div class="card" style="grid-column: 1 / -1;"><h2 class="card-title">Top Pages</h2><div class="table-container"><table id="pagesTable"><thead><tr><th>Page Title</th><th>Views</th><th>Users</th></tr></thead><tbody></tbody></table></div></div>
                </div>
            </div>
            <div id="social" class="tab-content">
                <div class="dashboard">
                     <div class="card"><h2 class="card-title">Social KPIs</h2><div class="kpi-container"><div class="kpi"><p class="kpi-label">Total Followers</p><p class="kpi-value" id="totalFollowers">0</p></div><div class="kpi"><p class="kpi-label">Total Reach</p><p class="kpi-value" id="totalReach">0</p></div><div class="kpi"><p class="kpi-label">Total Interactions</p><p class="kpi-value" id="totalInteractions">0</p></div></div></div>
                     <div class="card" style="grid-column: span 2;"><h2 class="card-title">Followers by Platform</h2><div class="chart-container"><canvas id="followersByPlatformChart"></canvas></div></div>
                </div>
            </div>
            </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyAqoLAJLVZyScFX6cG4eSJiroMkA4KH-nE'; 
        const FOLDER_ID = '1Kc8tHlVmPYMtNipycBRd0HSC61u2uLDP';
        const SHEET_NAME = 'Sheet1';

        const FILENAME_TO_KEY_MAP = {
            'Email_Campaign_Performance': 'emailCampaigns', 'FB_Audience': 'fbAudience', 'FB_Follows': 'fbFollows', 'FB_Interactions': 'fbInteractions', 'FB_Link_Clicks': 'fbLinkClicks', 'FB_Reach': 'fbReach', 'FB_Views': 'fbViews', 'FB_Visits': 'fbVisits', 'GA_Demographics': 'gaDemographics', 'GA_Pages_And_Screens': 'gaPages', 'GA_Traffic_Acquisition': 'gaTraffic', 'GA_UTMs': 'gaUtms', 'IG_Audience': 'igAudience', 'IG_Follows': 'igFollows', 'IG_Interactions': 'igInteractions', 'IG_Link_Clicks': 'igLinkClicks', 'IG_Reach': 'igReach', 'IG_Views': 'igViews', 'IG_Visits': 'igVisits', 'YouTube_Age': 'ytAge', 'YouTube_Content': 'ytContent', 'YouTube_Gender': 'ytGender', 'YouTube_Geography': 'ytGeo', 'YouTube_Subscription_Status': 'ytSubStatus'
        };
        // --- END CONFIGURATION ---

        const chartInstances = {};
        const processedData = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            document.getElementById('filterButton').addEventListener('click', updateDashboard);
        });

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');
        }

        async function getSpreadsheetIdsFromFolder(statusListElem) {
            const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}' in parents and trashed=false&key=${API_KEY}&fields=files(id,name)`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Google Drive API error! Status: ${response.status}. Check Folder ID, API Key, and Sharing Permissions.`);
            
            const data = await response.json();
            const foundFiles = data.files || [];
            
            const spreadsheetIds = {};
            const requiredFiles = Object.keys(FILENAME_TO_KEY_MAP);
            let matchedFileCount = 0;

            requiredFiles.forEach(requiredName => {
                const foundFile = foundFiles.find(f => f.name === requiredName);
                const key = FILENAME_TO_KEY_MAP[requiredName];
                const statusItem = document.createElement('li');

                if (foundFile) {
                    spreadsheetIds[key] = foundFile.id;
                    statusItem.innerHTML = `[<span class="status-found">FOUND</span>] ${requiredName}`;
                    matchedFileCount++;
                } else {
                    statusItem.innerHTML = `[<span class="status-missing">MISSING</span>] ${requiredName}`;
                }
                statusListElem.appendChild(statusItem);
            });

            if (matchedFileCount === 0) {
                throw new Error("No required files were found in the Google Drive folder. Please check the filenames and try again.");
            }
            return spreadsheetIds;
        }

        async function loadAllData() {
            const loader = document.getElementById('loader');
            const statusPanel = document.getElementById('status-panel');
            const statusList = document.getElementById('status-list');
            const statusMessage = document.getElementById('status-message');
            const dashboard = document.getElementById('dashboard-content');
            
            statusPanel.style.display = 'block';
            dashboard.style.display = 'none';

            try {
                const spreadsheetIds = await getSpreadsheetIdsFromFolder(statusList);
                
                statusMessage.textContent = `Found ${Object.keys(spreadsheetIds).length} matching file(s). Now fetching data...`;
                loader.textContent = 'Loading data from Google Sheets...';

                const keysToFetch = Object.keys(spreadsheetIds);
                const promises = keysToFetch.map(key => {
                    const sheetId = spreadsheetIds[key];
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${SHEET_NAME}?key=${API_KEY}`;
                    return fetch(url).then(res => res.json()).then(data => ({ 
                        key, 
                        data: googleSheetsValuesToObjects(data.values) 
                    }));
                });

                const results = await Promise.all(promises);
                const rawData = results.reduce((acc, { key, data }) => { acc[key] = data; return acc; }, {});

                processAllData(rawData);
                setDefaultDates();
                updateDashboard();
                
                document.getElementById('loader-container').style.display = 'none';
                dashboard.style.display = 'block';
                openTab('web'); // Ensure first tab is shown

            } catch (error) {
                loader.textContent = 'An error occurred!';
                statusMessage.innerHTML = `<span class="status-missing">${error.message}</span>`;
                console.error(error);
            }
        }
        
        function processAllData(rawData) {
            let minDate = new Date();
            let maxDate = new Date(1970, 0, 1);
            const addDate = (date) => {
                if (date) {
                    if (date < minDate) minDate = date;
                    if (date > maxDate) maxDate = date;
                }
            };
            
            for (const key in rawData) {
                if (Array.isArray(rawData[key])) {
                    processedData[key] = rawData[key].map(row => {
                        const date = parseDate(row['Date']); // Assuming a 'Date' column
                        addDate(date);
                        return { ...row, date };
                    });
                }
            }
            processedData.minDate = minDate;
            processedData.maxDate = maxDate;
        }

        function updateDashboard() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999);

            const filterByDate = (data) => data ? data.filter(row => row.date >= startDate && row.date <= endDate) : [];

            const filteredData = {};
            for (const key in processedData) {
                if(Array.isArray(processedData[key])) {
                     filteredData[key] = filterByDate(processedData[key]);
                }
            }
            
            // Call update functions for each dashboard tab
            updateWebAnalytics(filteredData);
            updateSocialAnalytics(filteredData);
        }

        function updateWebAnalytics(data) {
            const { gaDemographics, gaTraffic, gaPages } = data;
            if (!gaDemographics || !gaTraffic) return;

            let totalUsers = gaDemographics.reduce((sum, row) => sum + (parseInt(row['Total users']) || 0), 0);
            let totalSessions = gaTraffic.reduce((sum, row) => sum + (parseInt(row['Sessions']) || 0), 0);
            
            document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
            document.getElementById('totalSessions').textContent = formatNumber(totalSessions);

            const trafficSources = gaTraffic.reduce((acc, row) => {
                const source = row['Session source / medium'] || 'Unknown';
                acc[source] = (acc[source] || 0) + (parseInt(row['Sessions']) || 0);
                return acc;
            }, {});
            createOrUpdateChart('trafficSourcesChart', 'pie', trafficSources, 'Sessions by Source / Medium');
            
            if(gaPages) updateTable('pagesTable', gaPages, ['Page title', 'Views', 'Users'], 10, 'Views');
        }

        function updateSocialAnalytics(data) {
            const { fbFollows, igFollows, fbReach, igReach, fbInteractions, igInteractions } = data;
            if (!fbFollows || !igFollows) return;
            
            const lastFbFollowers = fbFollows.length > 0 ? parseInt(fbFollows[fbFollows.length - 1]['Value']) : 0;
            const lastIgFollowers = igFollows.length > 0 ? parseInt(igFollows[igFollows.length - 1]['Value']) : 0;
            document.getElementById('totalFollowers').textContent = formatNumber(lastFbFollowers + lastIgFollowers);

            const totalReach = (fbReach || []).reduce((sum, row) => sum + parseInt(row['Value']), 0) + (igReach || []).reduce((sum, row) => sum + parseInt(row['Value']), 0);
            document.getElementById('totalReach').textContent = formatNumber(totalReach);
            
            const totalInteractions = (fbInteractions || []).reduce((sum, row) => sum + parseInt(row['Value']), 0) + (igInteractions || []).reduce((sum, row) => sum + parseInt(row['Value']), 0);
            document.getElementById('totalInteractions').textContent = formatNumber(totalInteractions);

            const followersByPlatform = { 'Facebook': lastFbFollowers, 'Instagram': lastIgFollowers };
            createOrUpdateChart('followersByPlatformChart', 'bar', followersByPlatform, 'Followers by Platform');
        }

        // --- UTILITY FUNCTIONS ---
        function setDefaultDates() { /* ... */ }
        function formatNumber(num) { return num ? Number(num).toLocaleString() : '0'; }
        function destroyChart(chartId) { if (chartInstances[chartId]) chartInstances[chartId].destroy(); }
        function googleSheetsValuesToObjects(values) {
            if (!values || values.length < 2) return [];
            const headers = values[0];
            return values.slice(1).map(row => headers.reduce((obj, header, i) => {
                obj[header] = row[i];
                return obj;
            }, {}));
        }
        function parseDate(dateStr) {
            const date = new Date(dateStr);
            return isNaN(date) ? null : date;
        }
        function createOrUpdateChart(canvasId, type, data, title, options = {}) { /* ... */ }
        function updateTable(tableId, data, columns, rowLimit, sortColumn) { /* ... */ }

    </script>
</body>
</html>