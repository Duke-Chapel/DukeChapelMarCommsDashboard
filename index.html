<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500&family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        :root {
            --duke-navy: #1a365d;
            --duke-blue: #2563eb;
            --duke-light-blue: #3b82f6;
            --duke-orange: #ea580c;
            --duke-yellow: #f59e0b;
            --duke-teal: #0891b2;
            --duke-green: #059669;
            --duke-purple: #7c3aed;
            --duke-brown: #a3a3a3;
            --duke-gray: #6b7280;
            --duke-light-gray: #f3f4f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--duke-navy) 0%, var(--duke-blue) 50%, var(--duke-light-blue) 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
            padding: 40px 20px;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: linear-gradient(90deg, var(--duke-orange), var(--duke-yellow), var(--duke-teal));
            border-radius: 2px;
        }
        
        .header h1 {
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 3.2rem;
            font-weight: 600;
            margin: 20px 0 15px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            letter-spacing: -0.5px;
        }
        
        .header .subtitle {
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 400;
            margin-bottom: 10px;
        }
        
        .header .tagline {
            font-size: 1rem;
            opacity: 0.8;
            font-style: italic;
            font-weight: 300;
        }
        
        .upload-section {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border: 2px dashed var(--duke-blue);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .upload-section:hover {
            border-color: var(--duke-orange);
            transform: translateY(-3px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        
        .upload-area {
            text-align: center;
            padding: 40px 20px;
        }
        
        .upload-area h3 {
            font-family: 'EB Garamond', Georgia, serif;
            font-size: 1.8rem;
            color: var(--duke-navy);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .upload-area.dragover {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-color: var(--duke-orange);
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, var(--duke-blue), var(--duke-navy));
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            margin: 5px;
        }
        
        .upload-btn:hover {
            background: linear-gradient(135deg, var(--duke-orange), var(--duke-yellow));
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(234, 88, 12, 0.4);
        }
        
        .file-list {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }
        
        .file-item {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            border: 2px solid var(--duke-blue);
            font-weight: 500;
            color: var(--duke-navy);
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-group label {
            font-weight: 600;
            color: var(--duke-navy);
            font-size: 0.95rem;
            font-family: 'Montserrat', sans-serif;
        }
        
        .control-group input, .control-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Montserrat', sans-serif;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: var(--duke-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(37, 99, 235, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            margin-bottom: 25px;
            color: var(--duke-navy);
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'EB Garamond', Georgia, serif;
            border-bottom: 3px solid var(--duke-blue);
            padding-bottom: 12px;
            position: relative;
        }
        
        .card h3::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--duke-orange), var(--duke-yellow));
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }
        
        .metric {
            text-align: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-radius: 16px;
            border-left: 5px solid var(--duke-blue);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--duke-blue), var(--duke-orange));
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--duke-navy);
            margin-bottom: 8px;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--duke-gray);
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        .metric-change {
            font-size: 0.8rem;
            margin-top: 8px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        .metric-change.positive {
            color: var(--duke-green);
        }
        
        .metric-change.negative {
            color: #dc2626;
        }
        
        .metric-change.neutral {
            color: var(--duke-gray);
        }
        
        .chart-container {
            width: 100%;
            height: 350px;
            margin-top: 25px;
            position: relative;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            font-family: 'Montserrat', sans-serif;
        }
        
        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            font-weight: 700;
            color: var(--duke-navy);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .section-header {
            background: linear-gradient(135deg, var(--duke-navy), var(--duke-blue));
            color: white;
            padding: 30px;
            border-radius: 24px;
            margin: 40px 0 25px 0;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'EB Garamond', Georgia, serif;
            box-shadow: 0 15px 40px rgba(26, 54, 93, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .section-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--duke-gray);
            font-size: 1.1rem;
            font-family: 'Montserrat', sans-serif;
        }
        
        .error {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #dc2626;
            padding: 20px;
            border-radius: 16px;
            margin: 15px 0;
            border-left: 5px solid #dc2626;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        #dateRangeInfo {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            padding: 15px 20px;
            border-radius: 12px;
            border-left: 4px solid var(--duke-blue);
            font-size: 0.95rem;
            color: var(--duke-navy);
            font-weight: 500;
            margin-top: 15px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .data-overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .data-status-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 18px;
            border-radius: 16px;
            border-left: 4px solid var(--duke-blue);
        }
        
        .data-status-card h4 {
            margin: 0 0 8px 0;
            color: var(--duke-navy);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        
        .data-status-card p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--duke-gray);
            font-family: 'Montserrat', sans-serif;
        }
        
        .data-status-card small {
            color: #9ca3af;
            font-size: 0.8rem;
        }
        
        .format-selector {
            background: linear-gradient(135deg, #fef3cd, #fef3cd);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border-left: 4px solid var(--duke-orange);
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .metric-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .header .subtitle {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Duke Chapel Analytics</h1>
            <p class="subtitle">Marketing Performance Dashboard</p>
            <p class="tagline">Universal Analytics & GA4 Compatible â€¢ Comprehensive insights across digital platforms</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <h3>ðŸ“Š Upload Your Marketing Data Files</h3>
                <p style="margin: 20px 0; color: var(--duke-gray); font-size: 1.1rem;">Supports CSV files and Excel files from Universal Analytics or GA4</p>
                
                <div class="format-selector">
                    <h4 style="margin: 0 0 15px 0; color: var(--duke-navy);">ðŸ“‹ Data Format Selection</h4>
                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" name="dataFormat" value="auto" checked style="margin-right: 8px;">
                        <strong>Auto-detect</strong> - Dashboard will automatically detect your data format
                    </label>
                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" name="dataFormat" value="ga4" style="margin-right: 8px;">
                        <strong>GA4 CSV files</strong> - Modern Google Analytics 4 exports
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="radio" name="dataFormat" value="ua" style="margin-right: 8px;">
                        <strong>Universal Analytics</strong> - Excel files (.xlsx) from classic Google Analytics
                    </label>
                </div>
                
                <input type="file" id="fileInput" class="file-input" multiple accept=".csv,.xlsx">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    ðŸ“¤ Choose Files
                </button>
                <button class="upload-btn" onclick="loadSampleUAData()">
                    ðŸ”¬ Load Sample UA Data
                </button>
                <div class="file-list" id="fileList"></div>
            </div>
        </div>
        
        <div class="controls" id="controls" style="display: none;">
            <div class="control-group">
                <label>ðŸ“… Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="control-group">
                <label>ðŸ“… End Date</label>
                <input type="date" id="endDate">
            </div>
            <div class="control-group">
                <label>âš¡ Quick Select</label>
                <button class="upload-btn" onclick="selectFullRange()" style="padding: 10px 20px; font-size: 0.9rem;">Full Range</button>
            </div>
            <div class="control-group">
                <label>ðŸ“Š Compare With</label>
                <select id="compareType">
                    <option value="none">No Comparison</option>
                    <option value="previous">Previous Period</option>
                    <option value="year">Same Period Last Year</option>
                </select>
            </div>
            <button class="upload-btn" onclick="updateDashboard()">ðŸ”„ Update Dashboard</button>
            <div id="dateRangeInfo"></div>
        </div>
        
        <div id="dashboard"></div>
    </div>

    <script>
        let uploadedFiles = {};
        let processedData = {};
        let dataFormat = 'auto'; // 'auto', 'ga4', 'ua'
        
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        
        // Format selection handling
        document.querySelectorAll('input[name="dataFormat"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                dataFormat = e.target.value;
                console.log('Data format changed to:', dataFormat);
            });
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function loadSampleUAData() {
            // For demo purposes - in real use, this would load the actual UA files
            alert('Sample UA data would be loaded from your uploaded Excel files. Please upload your Universal Analytics Excel exports.');
        }
        
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'text/csv' || file.name.endsWith('.csv') || 
                    file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    uploadedFiles[file.name] = file;
                    displayFile(file.name);
                    processFile(file);
                }
            });
            
            if (Object.keys(uploadedFiles).length > 0) {
                document.getElementById('controls').style.display = 'flex';
                setDefaultDates();
                setupDateValidation();
            }
        }
        
        function setupDateValidation() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const compareTypeSelect = document.getElementById('compareType');
            
            startDateInput.addEventListener('change', () => {
                if (startDateInput.value && endDateInput.value) {
                    if (new Date(startDateInput.value) > new Date(endDateInput.value)) {
                        endDateInput.value = startDateInput.value;
                    }
                    updateDashboard();
                }
            });
            
            endDateInput.addEventListener('change', () => {
                if (startDateInput.value && endDateInput.value) {
                    if (new Date(endDateInput.value) < new Date(startDateInput.value)) {
                        startDateInput.value = endDateInput.value;
                    }
                    updateDashboard();
                }
            });
            
            compareTypeSelect.addEventListener('change', () => {
                if (startDateInput.value && endDateInput.value) {
                    updateDashboard();
                }
            });
        }
        
        function displayFile(fileName) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.textContent = fileName;
            fileList.appendChild(fileItem);
        }
        
        function processFile(file) {
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                processExcelFile(file);
            } else {
                processCSVFile(file);
            }
        }
        
        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Process Universal Analytics Excel format
                    processedData[file.name] = convertUAToStandardFormat(workbook, file.name);
                    
                    if (Object.keys(processedData).length === Object.keys(uploadedFiles).length) {
                        generateDashboard();
                    }
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    if (Object.keys(processedData).length === Object.keys(uploadedFiles).length - 1) {
                        generateDashboard();
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processCSVFile(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                encoding: 'utf-8',
                complete: (results) => {
                    processedData[file.name] = results.data;
                    if (Object.keys(processedData).length === Object.keys(uploadedFiles).length) {
                        generateDashboard();
                    }
                },
                error: (error) => {
                    console.log(`Error parsing ${file.name}:`, error);
                    if (Object.keys(processedData).length === Object.keys(uploadedFiles).length - 1) {
                        generateDashboard();
                    }
                }
            });
        }
        
        function convertUAToStandardFormat(workbook, fileName) {
            // Convert Universal Analytics Excel data to standard format for dashboard
            if (!workbook.Sheets['Dataset1']) {
                console.warn(`No Dataset1 sheet found in ${fileName}`);
                return [];
            }
            
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets['Dataset1']);
            
            // Determine the type of UA data and convert accordingly
            if (fileName.includes('Audience Overview')) {
                return convertUAAudienceData(rawData);
            } else if (fileName.includes('Acquisition Overview')) {
                return convertUATrafficData(rawData);
            } else if (fileName.includes('Landing Pages')) {
                return convertUALandingPagesData(rawData);
            } else if (fileName.includes('Pages')) {
                return convertUAPagesData(rawData);
            }
            
            return rawData;
        }
        
        function convertUAAudienceData(data) {
            // Convert UA audience data to GA4-like format
            return data.map(row => ({
                'Date + hour (YYYYMMDDHH)': formatDateToGA4(row['Day Index']),
                'Total users': row['Users'] || 0,
                'Active users': row['Users'] || 0,
                'New users': Math.round((row['Users'] || 0) * 0.7), // Estimate
                'Returning users': Math.round((row['Users'] || 0) * 0.3), // Estimate
                'Sessions': Math.round((row['Users'] || 0) * 1.2), // Estimate
                'Engagement rate': 0.65, // Default estimate
                'Average engagement time per session': 120, // Default estimate
                'User engagement': row['Users'] || 0,
                'Country': 'Unknown',
                'City': 'Unknown',
                'Language': 'Unknown',
                'Region': 'Unknown'
            }));
        }
        
        function convertUATrafficData(data) {
            // Convert UA acquisition data to GA4-like format
            return data.map(row => ({
                'Date + hour (YYYYMMDDHH)': '2023010100', // Default date
                'Session primary channel group (Default Channel Group)': row['Default Channel Grouping'] || 'Unknown',
                'Session campaign': 'Unknown',
                'Session source / medium': 'Unknown',
                'Engaged sessions': Math.round((row['Sessions'] || 0) * (1 - (row['Bounce Rate'] || 0.5))),
                'Engagement rate': 1 - (row['Bounce Rate'] || 0.5),
                'Average engagement time per session': row['Avg. Session Duration'] || 60,
                'Session key event rate': (row['Goal Conversion Rate'] || 0) * 100,
                'Key events': row['Goal Completions'] || 0,
                'Sessions': row['Sessions'] || 0,
                'Event count': Math.round((row['Sessions'] || 0) * (row['Pages / Session'] || 1.5)),
                'Events per session': row['Pages / Session'] || 1.5
            }));
        }
        
        function convertUALandingPagesData(data) {
            // Convert UA landing pages data to GA4-like format
            return data.map(row => ({
                'Date + hour (YYYYMMDDHH)': '2023010100', // Default date
                'Page path and screen class': row['Landing Page'] || 'Unknown',
                'Page title and screen class': row['Landing Page'] || 'Unknown',
                'Page title and screen name': row['Landing Page'] || 'Unknown',
                'Content group': 'General',
                'Views': Math.round((row['Sessions'] || 0) * (row['Pages / Session'] || 1.5)),
                'Views per active user': row['Pages / Session'] || 1.5,
                'Key events': row['Goal Completions'] || 0,
                'Event count': Math.round((row['Sessions'] || 0) * (row['Pages / Session'] || 1.5)),
                'Active users': row['New Users'] || Math.round((row['Sessions'] || 0) * 0.8)
            }));
        }
        
        function convertUAPagesData(data) {
            // Convert UA pages data to GA4-like format
            return data.map(row => ({
                'Date + hour (YYYYMMDDHH)': '2023010100', // Default date
                'Page path and screen class': row['Page'] || 'Unknown',
                'Page title and screen class': row['Page'] || 'Unknown',
                'Page title and screen name': row['Page'] || 'Unknown',
                'Content group': 'General',
                'Views': row['Pageviews'] || 0,
                'Views per active user': 1.5,
                'Key events': 0,
                'Event count': row['Pageviews'] || 0,
                'Active users': row['Unique Pageviews'] || Math.round((row['Pageviews'] || 0) * 0.8)
            }));
        }
        
        function formatDateToGA4(dateStr) {
            // Convert various date formats to GA4 YYYYMMDDHH format
            if (!dateStr) return '2023010100';
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '2023010100';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            
            return `${year}${month}${day}${hour}`;
        }
        
        function setDefaultDates() {
            const dateRange = getDataDateRange();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            
            if (dateRange.min && dateRange.max) {
                startDateInput.min = dateRange.min.toISOString().split('T')[0];
                startDateInput.max = dateRange.max.toISOString().split('T')[0];
                endDateInput.min = dateRange.min.toISOString().split('T')[0];
                endDateInput.max = dateRange.max.toISOString().split('T')[0];
                
                const minDateStr = dateRange.min.toLocaleDateString();
                const maxDateStr = dateRange.max.toLocaleDateString();
                dateRangeInfo.innerHTML = `ðŸ“… Data available from ${minDateStr} to ${maxDateStr}`;
                
                const daysDiff = (dateRange.max - dateRange.min) / (1000 * 60 * 60 * 24);
                if (daysDiff <= 30) {
                    startDateInput.value = dateRange.min.toISOString().split('T')[0];
                    endDateInput.value = dateRange.max.toISOString().split('T')[0];
                } else {
                    const thirtyDaysAgo = new Date(dateRange.max.getTime() - (30 * 24 * 60 * 60 * 1000));
                    startDateInput.value = Math.max(thirtyDaysAgo, dateRange.min).toISOString().split('T')[0];
                    endDateInput.value = dateRange.max.toISOString().split('T')[0];
                }
            } else {
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                
                endDateInput.value = today.toISOString().split('T')[0];
                startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                dateRangeInfo.innerHTML = `âš ï¸ No date data found in files - using current date`;
            }
        }
        
        function getDataDateRange() {
            let minDate = null;
            let maxDate = null;
            
            // Check for GA4 format files
            ['GA_Demographics.csv', 'GA_Traffic_Acquisition.csv', 'GA_Pages_And_Screens.csv', 'GA_UTMs.csv'].forEach(fileName => {
                if (processedData[fileName]) {
                    processedData[fileName].forEach(row => {
                        const dateField = row['Date + hour (YYYYMMDDHH)'];
                        if (dateField) {
                            const date = parseDate(dateField);
                            if (!isNaN(date.getTime())) {
                                if (!minDate || date < minDate) minDate = date;
                                if (!maxDate || date > maxDate) maxDate = date;
                            }
                        }
                    });
                }
            });
            
            // Check for Universal Analytics converted data
            Object.keys(processedData).forEach(fileName => {
                if (fileName.includes('Analytics www.chapel.duke.edu')) {
                    processedData[fileName].forEach(row => {
                        const dateField = row['Date + hour (YYYYMMDDHH)'];
                        if (dateField) {
                            const date = parseDate(dateField);
                            if (!isNaN(date.getTime())) {
                                if (!minDate || date < minDate) minDate = date;
                                if (!maxDate || date > maxDate) maxDate = date;
                            }
                        }
                    });
                }
            });
            
            // Fallback: check social media data
            ['FB_Interactions.csv', 'FB_Reach.csv', 'FB_Follows.csv', 'FB_Link_clicks.csv', 'FB_Views.csv', 'FB_Visits.csv',
             'IG_Interactions.csv', 'IG_Reach.csv', 'IG_Follows.csv', 'IG_Link_clicks.csv', 'IG_Views.csv', 'IG_Visits.csv'].forEach(fileName => {
                if (processedData[fileName]) {
                    processedData[fileName].forEach(row => {
                        if (row.Date) {
                            const date = new Date(row.Date);
                            if (!isNaN(date.getTime())) {
                                if (!minDate || date < minDate) minDate = date;
                                if (!maxDate || date > maxDate) maxDate = date;
                            }
                        }
                    });
                }
            });
            
            return { min: minDate, max: maxDate };
        }
        
        function parsePercentage(str) {
            if (str === null || str === undefined || str === '') return 0;
            if (typeof str === 'number') return isNaN(str) ? 0 : str;
            if (typeof str === 'string') {
                const cleaned = str.replace(/[%,\s]/g, '');
                if (cleaned === '') return 0;
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        }
        
        function parseNumber(str) {
            if (str === null || str === undefined || str === '') return 0;
            if (typeof str === 'number') return isNaN(str) ? 0 : str;
            if (typeof str === 'string') {
                const cleaned = str.replace(/[,\s]/g, '');
                if (cleaned === '') return 0;
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        }
        
        function parseDate(dateStr) {
            if (typeof dateStr === 'number' && dateStr.toString().length === 10) {
                const str = dateStr.toString();
                const year = str.substring(0, 4);
                const month = str.substring(4, 6);
                const day = str.substring(6, 8);
                const hour = str.substring(8, 10);
                return new Date(year, month - 1, day, hour);
            } else if (typeof dateStr === 'string') {
                return new Date(dateStr);
            }
            return new Date(dateStr);
        }
        
        function filterDataByDate(data, dateField, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            return data.filter(row => {
                const date = parseDate(row[dateField]);
                return date >= start && date <= end;
            });
        }
        
        function selectFullRange() {
            const dateRange = getDataDateRange();
            if (dateRange.min && dateRange.max) {
                document.getElementById('startDate').value = dateRange.min.toISOString().split('T')[0];
                document.getElementById('endDate').value = dateRange.max.toISOString().split('T')[0];
                updateDashboard();
            }
        }
        
        function generateDashboard(startDate = null, endDate = null, compareType = 'none') {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            
            // Add data overview section
            const dataOverview = createDataOverview(startDate, endDate);
            dashboard.appendChild(dataOverview);
            
            // Web Analytics Section
            const hasWebData = checkForWebData();
            if (hasWebData) {
                dashboard.appendChild(createSectionHeader('ðŸŒ Web Analytics'));
                generateWebAnalytics(dashboard, startDate, endDate, compareType);
            }
            
            // Social Media Section
            if (processedData['FB_Interactions.csv'] || processedData['IG_Posts.csv'] || processedData['FB_Videos.csv']) {
                dashboard.appendChild(createSectionHeader('ðŸ“± Social Media Analytics'));
                generateSocialAnalytics(dashboard, startDate, endDate, compareType);
            }
            
            // Email Section
            if (processedData['Email_Campaign_Performance.csv']) {
                dashboard.appendChild(createSectionHeader('ðŸ“§ Email Marketing Analytics'));
                generateEmailAnalytics(dashboard, startDate, endDate, compareType);
            }
            
            // YouTube Section
            if (processedData['YouTube_Content.csv']) {
                dashboard.appendChild(createSectionHeader('ðŸŽ¥ YouTube Analytics'));
                generateYouTubeAnalytics(dashboard, startDate, endDate, compareType);
            }
        }
        
        function checkForWebData() {
            // Check for GA4 data
            if (processedData['GA_Demographics.csv'] || processedData['GA_Traffic_Acquisition.csv']) {
                return true;
            }
            
            // Check for converted UA data
            return Object.keys(processedData).some(fileName => 
                fileName.includes('Analytics www.chapel.duke.edu')
            );
        }
        
        function createDataOverview(startDate, endDate) {
            const overviewCard = createCard('ðŸ“‹ Data Overview & Status');
            
            const dataTypes = {
                'Web Analytics (GA4)': ['GA_Demographics.csv', 'GA_Traffic_Acquisition.csv', 'GA_Pages_And_Screens.csv', 'GA_UTMs.csv'],
                'Web Analytics (UA)': Object.keys(processedData).filter(f => f.includes('Analytics www.chapel.duke.edu')),
                'Facebook': ['FB_Interactions.csv', 'FB_Reach.csv', 'FB_Follows.csv', 'FB_Videos.csv', 'FB_Posts.csv'],
                'Instagram': ['IG_Posts.csv', 'IG_Interactions.csv', 'IG_Reach.csv', 'IG_Follows.csv'],
                'Email': ['Email_Campaign_Performance.csv'],
                'YouTube': ['YouTube_Content.csv', 'YouTube_Age.csv', 'YouTube_Gender.csv', 'YouTube_Geography.csv']
            };
            
            let overviewHTML = `<div class="data-overview-grid">`;
            
            Object.entries(dataTypes).forEach(([category, files]) => {
                const loadedFiles = files.filter(file => processedData[file]);
                const totalFiles = files.length;
                const loadedCount = loadedFiles.length;
                
                let statusColor = loadedCount === 0 ? '#dc2626' : loadedCount === totalFiles ? 'var(--duke-green)' : 'var(--duke-orange)';
                let statusIcon = loadedCount === 0 ? 'âŒ' : loadedCount === totalFiles ? 'âœ…' : 'âš ï¸';
                
                if (category === 'Web Analytics (UA)' && loadedCount > 0) {
                    statusColor = 'var(--duke-green)';
                    statusIcon = 'âœ…';
                }
                
                overviewHTML += `
                    <div class="data-status-card" style="border-left-color: ${statusColor};">
                        <h4>${statusIcon} ${category}</h4>
                        <p>${loadedCount}${category.includes('UA') ? '' : '/' + totalFiles} files loaded</p>
                        ${loadedFiles.length > 0 ? `<small>Loaded: ${loadedFiles.slice(0, 3).join(', ')}${loadedFiles.length > 3 ? '...' : ''}</small>` : ''}
                    </div>
                `;
            });
            
            overviewHTML += '</div>';
            
            if (startDate && endDate) {
                overviewHTML += `
                    <div style="background: linear-gradient(135deg, #fef3cd, #fef3cd); padding: 15px; border-radius: 16px; margin-top: 15px; border-left: 4px solid var(--duke-orange);">
                        <h4 style="margin: 0 0 8px 0; color: var(--duke-navy); font-family: 'Montserrat', sans-serif; font-weight: 600;">ðŸ“… Date Range Filter Active</h4>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--duke-gray); font-family: 'Montserrat', sans-serif;">
                            Showing data from <strong>${new Date(startDate).toLocaleDateString()}</strong> to <strong>${new Date(endDate).toLocaleDateString()}</strong>
                        </p>
                    </div>
                `;
            }
            
            overviewCard.innerHTML += overviewHTML;
            return overviewCard;
        }
        
        function createSectionHeader(title) {
            const header = document.createElement('div');
            header.className = 'section-header';
            header.textContent = title;
            return header;
        }
        
        function generateWebAnalytics(dashboard, startDate = null, endDate = null, compareType = 'none') {
            const container = document.createElement('div');
            container.className = 'dashboard';
            
            // Get the appropriate web data source
            const webDataSource = getWebDataSource();
            
            if (webDataSource) {
                // Demographics Card
                const card = createCard('ðŸŒ User Demographics & Overview');
                
                let demographics = webDataSource.demographics;
                if (startDate && endDate && demographics) {
                    demographics = filterDataByDate(demographics, 'Date + hour (YYYYMMDDHH)', startDate, endDate);
                }
                
                if (demographics && demographics.length > 0) {
                    const totalUsers = demographics.reduce((sum, row) => sum + parseNumber(row['Total users']), 0);
                    const newUsers = demographics.reduce((sum, row) => sum + parseNumber(row['New users']), 0);
                    const returningUsers = demographics.reduce((sum, row) => sum + parseNumber(row['Returning users']), 0);
                    const totalSessions = demographics.reduce((sum, row) => sum + parseNumber(row.Sessions), 0);
                    const avgEngagement = demographics.length > 0 ? 
                        demographics.reduce((sum, row) => sum + parseNumber(row['Engagement rate']), 0) / demographics.length : 0;
                    
                    const metricsGrid = document.createElement('div');
                    metricsGrid.className = 'metric-grid';
                    metricsGrid.innerHTML = `
                        ${createMetricWithComparison(totalUsers, 'Total Users', null)}
                        ${createMetricWithComparison(newUsers, 'New Users', null)}
                        ${createMetricWithComparison(Math.round((newUsers/totalUsers) * 100) + '%', 'New User %', null)}
                        ${createMetricWithComparison(totalSessions, 'Sessions', null)}
                        ${createMetricWithComparison((avgEngagement * 100).toFixed(1) + '%', 'Engagement Rate', null)}
                        ${createMetricWithComparison(returningUsers, 'Returning Users', null)}
                    `;
                    card.appendChild(metricsGrid);
                }
                
                container.appendChild(card);
                
                // Traffic Sources Card
                if (webDataSource.traffic) {
                    let traffic = webDataSource.traffic;
                    if (startDate && endDate) {
                        traffic = filterDataByDate(traffic, 'Date + hour (YYYYMMDDHH)', startDate, endDate);
                    }
                    
                    const trafficCard = createCard('ðŸš€ Traffic Sources & Channels');
                    
                    const channelData = traffic.reduce((acc, row) => {
                        const channel = row['Session primary channel group (Default Channel Group)'] || 'Unknown';
                        if (!acc[channel]) {
                            acc[channel] = { 
                                sessions: 0, 
                                engagedSessions: 0, 
                                keyEvents: 0,
                                avgEngagementTime: 0,
                                count: 0
                            };
                        }
                        acc[channel].sessions += parseNumber(row.Sessions);
                        acc[channel].engagedSessions += parseNumber(row['Engaged sessions']);
                        acc[channel].keyEvents += parseNumber(row['Key events']);
                        acc[channel].avgEngagementTime += parseNumber(row['Average engagement time per session']);
                        acc[channel].count++;
                        return acc;
                    }, {});
                    
                    // Calculate averages
                    Object.keys(channelData).forEach(channel => {
                        channelData[channel].avgEngagementTime = channelData[channel].avgEngagementTime / channelData[channel].count;
                        channelData[channel].engagementRate = channelData[channel].sessions > 0 ? 
                            (channelData[channel].engagedSessions / channelData[channel].sessions) * 100 : 0;
                    });
                    
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    const canvas = document.createElement('canvas');
                    chartContainer.appendChild(canvas);
                    trafficCard.appendChild(chartContainer);
                    
                    setTimeout(() => {
                        new Chart(canvas, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(channelData),
                                datasets: [{
                                    data: Object.values(channelData).map(d => d.sessions),
                                    backgroundColor: [
                                        '#1a365d', '#2563eb', '#ea580c', '#f59e0b',
                                        '#0891b2', '#059669', '#7c3aed', '#a3a3a3',
                                        '#6b7280', '#f3f4f6'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true,
                                            font: {
                                                family: 'Montserrat'
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }, 100);
                    
                    container.appendChild(trafficCard);
                }
                
                // Pages Performance
                if (webDataSource.pages) {
                    let pages = webDataSource.pages;
                    if (startDate && endDate) {
                        pages = filterDataByDate(pages, 'Date + hour (YYYYMMDDHH)', startDate, endDate);
                    }
                    
                    const pagesCard = createCard('ðŸ“„ Top Pages Performance');
                    
                    const pageData = pages.reduce((acc, row) => {
                        const path = row['Page path and screen class'] || 'Unknown';
                        if (!acc[path]) {
                            acc[path] = { 
                                views: 0, 
                                users: 0, 
                                keyEvents: 0,
                                eventCount: 0 
                            };
                        }
                        acc[path].views += parseNumber(row.Views);
                        acc[path].users += parseNumber(row['Active users']);
                        acc[path].keyEvents += parseNumber(row['Key events']);
                        acc[path].eventCount += parseNumber(row['Event count']);
                        return acc;
                    }, {});
                    
                    const topPages = Object.entries(pageData)
                        .sort(([,a], [,b]) => b.views - a.views)
                        .slice(0, 10);
                    
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';
                    tableContainer.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Page Path</th>
                                    <th>Views</th>
                                    <th>Users</th>
                                    <th>Key Events</th>
                                    <th>Events/View</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topPages.map(([page, data]) => 
                                    `<tr>
                                        <td><strong>${page}</strong></td>
                                        <td>${data.views.toLocaleString()}</td>
                                        <td>${data.users.toLocaleString()}</td>
                                        <td>${data.keyEvents.toLocaleString()}</td>
                                        <td>${data.views > 0 ? (data.eventCount / data.views).toFixed(2) : '0'}</td>
                                    </tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    `;
                    pagesCard.appendChild(tableContainer);
                    container.appendChild(pagesCard);
                }
            }
            
            dashboard.appendChild(container);
        }
        
        function getWebDataSource() {
            // Check for GA4 data first
            if (processedData['GA_Demographics.csv'] || processedData['GA_Traffic_Acquisition.csv']) {
                return {
                    demographics: processedData['GA_Demographics.csv'],
                    traffic: processedData['GA_Traffic_Acquisition.csv'],
                    pages: processedData['GA_Pages_And_Screens.csv']
                };
            }
            
            // Check for converted UA data
            const uaFiles = Object.keys(processedData).filter(f => f.includes('Analytics www.chapel.duke.edu'));
            if (uaFiles.length > 0) {
                return {
                    demographics: processedData[uaFiles.find(f => f.includes('Audience'))],
                    traffic: processedData[uaFiles.find(f => f.includes('Acquisition'))],
                    pages: processedData[uaFiles.find(f => f.includes('Pages')) || uaFiles.find(f => f.includes('Landing'))]
                };
            }
            
            return null;
        }
        
        function createMetricWithComparison(value, label, comparisonValue = null) {
            let changeIndicator = '';
            
            if (comparisonValue !== null && comparisonValue !== 0) {
                const numValue = typeof value === 'string' ? parseFloat(value.replace(/[,%]/g, '')) : value;
                const change = ((numValue - comparisonValue) / comparisonValue) * 100;
                const changeIcon = change > 0 ? 'ðŸ“ˆ' : change < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
                changeIndicator = `<div class="metric-change ${changeClass}">
                    ${changeIcon} ${change > 0 ? '+' : ''}${change.toFixed(1)}% vs previous
                </div>`;
            }
            
            return `
                <div class="metric">
                    <div class="metric-value">${typeof value === 'number' ? value.toLocaleString() : value}</div>
                    <div class="metric-label">${label}</div>
                    ${changeIndicator}
                </div>
            `;
        }
        
        function createCard(title) {
            const card = document.createElement('div');
            card.className = 'card';
            
            const header = document.createElement('h3');
            header.textContent = title;
            card.appendChild(header);
            
            return card;
        }
        
        function updateDashboard() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const compareType = document.getElementById('compareType').value;
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            
            if (startDate && endDate) {
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const daysDiff = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;
                
                const dataRange = getDataDateRange();
                let rangeText = `ðŸ“… Showing ${daysDiff} days: ${startDateObj.toLocaleDateString()} - ${endDateObj.toLocaleDateString()}`;
                if (dataRange.min && dataRange.max) {
                    rangeText += ` (Available: ${dataRange.min.toLocaleDateString()} - ${dataRange.max.toLocaleDateString()})`;
                }
                
                dateRangeInfo.innerHTML = rangeText;
                generateDashboard(startDate, endDate, compareType);
            } else {
                generateDashboard();
            }
        }
        
        function generateSocialAnalytics(dashboard, startDate = null, endDate = null, compareType = 'none') {
            const container = document.createElement('div');
            container.className = 'dashboard';
            
            // Facebook Analytics Overview
            if (processedData['FB_Interactions.csv'] || processedData['FB_Reach.csv']) {
                const card = createCard('ðŸ“˜ Facebook Performance');
                const metricsGrid = document.createElement('div');
                metricsGrid.className = 'metric-grid';
                
                let fbReach = 0, fbInteractions = 0, fbFollows = 0, fbViews = 0, fbVisits = 0, fbLinkClicks = 0;
                
                // Calculate Facebook metrics
                if (processedData['FB_Reach.csv']) {
                    let reachData = processedData['FB_Reach.csv'];
                    if (startDate && endDate) {
                        reachData = filterDataByDate(reachData, 'Date', startDate, endDate);
                    }
                    fbReach = reachData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['FB_Interactions.csv']) {
                    let interactionData = processedData['FB_Interactions.csv'];
                    if (startDate && endDate) {
                        interactionData = filterDataByDate(interactionData, 'Date', startDate, endDate);
                    }
                    fbInteractions = interactionData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['FB_Follows.csv']) {
                    let followData = processedData['FB_Follows.csv'];
                    if (startDate && endDate) {
                        followData = filterDataByDate(followData, 'Date', startDate, endDate);
                    }
                    fbFollows = followData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['FB_Views.csv']) {
                    let viewData = processedData['FB_Views.csv'];
                    if (startDate && endDate) {
                        viewData = filterDataByDate(viewData, 'Date', startDate, endDate);
                    }
                    fbViews = viewData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['FB_Visits.csv']) {
                    let visitData = processedData['FB_Visits.csv'];
                    if (startDate && endDate) {
                        visitData = filterDataByDate(visitData, 'Date', startDate, endDate);
                    }
                    fbVisits = visitData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['FB_Link_clicks.csv']) {
                    let linkData = processedData['FB_Link_clicks.csv'];
                    if (startDate && endDate) {
                        linkData = filterDataByDate(linkData, 'Date', startDate, endDate);
                    }
                    fbLinkClicks = linkData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                metricsGrid.innerHTML = `
                    ${createMetricWithComparison(fbReach, 'Total Reach', null)}
                    ${createMetricWithComparison(fbInteractions, 'Interactions', null)}
                    ${createMetricWithComparison(fbFollows, 'New Follows', null)}
                    ${createMetricWithComparison(fbViews, 'Profile Views', null)}
                    ${createMetricWithComparison(fbVisits, 'Page Visits', null)}
                    ${createMetricWithComparison(fbLinkClicks, 'Link Clicks', null)}
                `;
                
                card.appendChild(metricsGrid);
                container.appendChild(card);
            }
            
            // Instagram Analytics Overview  
            if (processedData['IG_Interactions.csv'] || processedData['IG_Reach.csv']) {
                const card = createCard('ðŸ“· Instagram Performance');
                const metricsGrid = document.createElement('div');
                metricsGrid.className = 'metric-grid';
                
                let igReach = 0, igInteractions = 0, igFollows = 0, igViews = 0, igVisits = 0, igLinkClicks = 0;
                
                if (processedData['IG_Reach.csv']) {
                    let reachData = processedData['IG_Reach.csv'];
                    if (startDate && endDate) {
                        reachData = filterDataByDate(reachData, 'Date', startDate, endDate);
                    }
                    igReach = reachData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['IG_Interactions.csv']) {
                    let interactionData = processedData['IG_Interactions.csv'];
                    if (startDate && endDate) {
                        interactionData = filterDataByDate(interactionData, 'Date', startDate, endDate);
                    }
                    igInteractions = interactionData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['IG_Follows.csv']) {
                    let followData = processedData['IG_Follows.csv'];
                    if (startDate && endDate) {
                        followData = filterDataByDate(followData, 'Date', startDate, endDate);
                    }
                    igFollows = followData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['IG_Views.csv']) {
                    let viewData = processedData['IG_Views.csv'];
                    if (startDate && endDate) {
                        viewData = filterDataByDate(viewData, 'Date', startDate, endDate);
                    }
                    igViews = viewData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['IG_Visits.csv']) {
                    let visitData = processedData['IG_Visits.csv'];
                    if (startDate && endDate) {
                        visitData = filterDataByDate(visitData, 'Date', startDate, endDate);
                    }
                    igVisits = visitData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                if (processedData['IG_Link_clicks.csv']) {
                    let linkData = processedData['IG_Link_clicks.csv'];
                    if (startDate && endDate) {
                        linkData = filterDataByDate(linkData, 'Date', startDate, endDate);
                    }
                    igLinkClicks = linkData.reduce((sum, row) => sum + parseNumber(row.Primary), 0);
                }
                
                metricsGrid.innerHTML = `
                    ${createMetricWithComparison(igReach, 'Total Reach', null)}
                    ${createMetricWithComparison(igInteractions, 'Interactions', null)}
                    ${createMetricWithComparison(igFollows, 'New Follows', null)}
                    ${createMetricWithComparison(igViews, 'Profile Views', null)}
                    ${createMetricWithComparison(igVisits, 'Page Visits', null)}
                    ${createMetricWithComparison(igLinkClicks, 'Link Clicks', null)}
                `;
                
                card.appendChild(metricsGrid);
                container.appendChild(card);
            }
            
            // Top Instagram Posts Analysis
            if (processedData['IG_Posts.csv']) {
                let posts = processedData['IG_Posts.csv'];
                
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    posts = posts.filter(post => {
                        if (post['Publish time']) {
                            const postDate = new Date(post['Publish time']);
                            return postDate >= start && postDate <= end;
                        } else if (post['Date']) {
                            const postDate = new Date(post['Date']);
                            return postDate >= start && postDate <= end;
                        }
                        return true;
                    });
                }
                
                const card = createCard('ðŸ† Top Instagram Posts Performance');
                
                // Create tabs for different sorting options
                const tabContainer = document.createElement('div');
                tabContainer.style.cssText = 'display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;';
                
                ['Reach', 'Likes', 'Comments', 'Saves', 'Shares'].forEach((metric, index) => {
                    const tab = document.createElement('button');
                    tab.className = 'upload-btn';
                    tab.style.cssText = `padding: 8px 16px; font-size: 0.85rem; ${index === 0 ? 'background: linear-gradient(135deg, var(--duke-blue), var(--duke-navy));' : 'background: var(--duke-light-gray); color: var(--duke-gray);'}`;
                    tab.textContent = `Top by ${metric}`;
                    tab.onclick = () => displayTopPosts(metric, posts, card);
                    tabContainer.appendChild(tab);
                });
                
                card.appendChild(tabContainer);
                displayTopPosts('Reach', posts, card);
                container.appendChild(card);
            }
            
            dashboard.appendChild(container);
        }
        
        function displayTopPosts(metric, posts, card) {
            // Remove existing table if any
            const existingTable = card.querySelector('.table-container');
            if (existingTable) {
                existingTable.remove();
            }
            
            // Update tab styles
            const tabs = card.querySelectorAll('button');
            tabs.forEach((tab, index) => {
                if (tab.textContent.includes(metric)) {
                    tab.style.background = 'linear-gradient(135deg, var(--duke-blue), var(--duke-navy))';
                    tab.style.color = 'white';
                } else {
                    tab.style.background = 'var(--duke-light-gray)';
                    tab.style.color = 'var(--duke-gray)';
                }
            });
            
            const topPosts = posts
                .filter(post => parseNumber(post[metric] || 0) > 0)
                .sort((a, b) => parseNumber(b[metric] || 0) - parseNumber(a[metric] || 0))
                .slice(0, 5);
            
            if (topPosts.length === 0) {
                const noDataDiv = document.createElement('div');
                noDataDiv.style.cssText = 'text-align: center; padding: 40px; color: var(--duke-gray); font-style: italic;';
                noDataDiv.innerHTML = `ðŸ“­ No posts found with ${metric} data for the selected period.`;
                card.appendChild(noDataDiv);
                return;
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            tableContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Post</th>
                            <th>${metric}</th>
                            <th>Reach</th>
                            <th>Likes</th>
                            <th>Comments</th>
                            <th>Shares</th>
                            <th>Saves</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topPosts.map(post => 
                            `<tr>
                                <td><strong>${(post.Description || 'No description').substring(0, 40)}...</strong></td>
                                <td><strong>${parseNumber(post[metric] || 0).toLocaleString()}</strong></td>
                                <td>${parseNumber(post.Reach || 0).toLocaleString()}</td>
                                <td>${parseNumber(post.Likes || 0).toLocaleString()}</td>
                                <td>${parseNumber(post.Comments || 0).toLocaleString()}</td>
                                <td>${parseNumber(post.Shares || 0).toLocaleString()}</td>
                                <td>${parseNumber(post.Saves || 0).toLocaleString()}</td>
                                <td>${post.Permalink ? `<a href="${post.Permalink}" target="_blank" style="color: var(--duke-blue); text-decoration: none; font-weight: bold;">ðŸ”— View</a>` : 'N/A'}</td>
                            </tr>`
                        ).join('')}
                    </tbody>
                </table>
            `;
            card.appendChild(tableContainer);
        }
        
        function generateEmailAnalytics(dashboard, startDate = null, endDate = null, compareType = 'none') {
            if (!processedData['Email_Campaign_Performance.csv']) {
                const container = document.createElement('div');
                container.className = 'dashboard';
                const card = createCard('ðŸ“§ Email Marketing Analytics');
                card.innerHTML += '<p style="text-align: center; padding: 20px; color: var(--duke-gray);">Email analytics will be displayed here when you upload your email campaign CSV files.</p>';
                container.appendChild(card);
                dashboard.appendChild(container);
                return;
            }
            
            let emailData = processedData['Email_Campaign_Performance.csv'];
            
            const container = document.createElement('div');
            container.className = 'dashboard';
            
            // Enhanced Email Overview
            const overviewCard = createCard('ðŸ“Š Email Campaign Overview');
            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'metric-grid';
            
            const totalSent = emailData.reduce((sum, row) => sum + parseNumber(row['Emails sent']), 0);
            const totalDelivered = emailData.reduce((sum, row) => sum + parseNumber(row['Email deliveries']), 0);
            const totalOpened = emailData.reduce((sum, row) => sum + parseNumber(row['Email opened (MPP excluded)']), 0);
            const totalClicked = emailData.reduce((sum, row) => sum + parseNumber(row['Email clicked']), 0);
            const totalBounced = emailData.reduce((sum, row) => sum + parseNumber(row['Email bounces']), 0);
            const totalUnsubscribed = emailData.reduce((sum, row) => sum + parseNumber(row['Email unsubscribes']), 0);
            
            const overallOpenRate = totalDelivered > 0 ? (totalOpened / totalDelivered) * 100 : 0;
            const overallClickRate = totalDelivered > 0 ? (totalClicked / totalDelivered) * 100 : 0;
            const overallBounceRate = totalSent > 0 ? (totalBounced / totalSent) * 100 : 0;
            const clickToOpenRate = totalOpened > 0 ? (totalClicked / totalOpened) * 100 : 0;
            
            // Calculate subscriber engagement percentages
            const activeSubscribers = totalDelivered;
            const nonOpeners = activeSubscribers - totalOpened;
            const openersWhoDidntClick = totalOpened - totalClicked;
            const nonOpenerPercentage = activeSubscribers > 0 ? (nonOpeners / activeSubscribers) * 100 : 0;
            const openerNoClickPercentage = activeSubscribers > 0 ? (openersWhoDidntClick / activeSubscribers) * 100 : 0;
            
            metricsGrid.innerHTML = `
                <div class="metric">
                    <div class="metric-value">${totalSent.toLocaleString()}</div>
                    <div class="metric-label">Total Sent</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${overallOpenRate.toFixed(1)}%</div>
                    <div class="metric-label">Overall Open Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${overallClickRate.toFixed(1)}%</div>
                    <div class="metric-label">Overall Click Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${clickToOpenRate.toFixed(1)}%</div>
                    <div class="metric-label">Click-to-Open Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${nonOpenerPercentage.toFixed(1)}%</div>
                    <div class="metric-label">Non-Openers</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${openerNoClickPercentage.toFixed(1)}%</div>
                    <div class="metric-label">Opened, No Click</div>
                </div>
            `;
            
            overviewCard.appendChild(metricsGrid);
            container.appendChild(overviewCard);
            
            // Top Campaigns by Open Rate
            const topOpenCard = createCard('ðŸ† Top 5 Campaigns by Open Rate');
            const topOpenCampaigns = emailData
                .sort((a, b) => parsePercentage(b['Email open rate (MPP excluded)']) - parsePercentage(a['Email open rate (MPP excluded)']))
                .slice(0, 5);
            
            const openTableContainer = document.createElement('div');
            openTableContainer.className = 'table-container';
            openTableContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Open Rate</th>
                            <th>Opens</th>
                            <th>Sent</th>
                            <th>Delivered</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topOpenCampaigns.map(campaign => 
                            `<tr>
                                <td><strong>${campaign.Campaign}</strong></td>
                                <td><strong>${campaign['Email open rate (MPP excluded)']}</strong></td>
                                <td>${parseNumber(campaign['Email opened (MPP excluded)']).toLocaleString()}</td>
                                <td>${parseNumber(campaign['Emails sent']).toLocaleString()}</td>
                                <td>${parseNumber(campaign['Email deliveries']).toLocaleString()}</td>
                            </tr>`
                        ).join('')}
                    </tbody>
                </table>
            `;
            topOpenCard.appendChild(openTableContainer);
            container.appendChild(topOpenCard);
            
            // Top Campaigns by Click Rate
            const topClickCard = createCard('ðŸŽ¯ Top 5 Campaigns by Click Rate');
            const topClickCampaigns = emailData
                .sort((a, b) => parsePercentage(b['Email click rate']) - parsePercentage(a['Email click rate']))
                .slice(0, 5);
            
            const clickTableContainer = document.createElement('div');
            clickTableContainer.className = 'table-container';
            clickTableContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Click Rate</th>
                            <th>Clicks</th>
                            <th>Total Clicks</th>
                            <th>CTR (Click-to-Open)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topClickCampaigns.map(campaign => 
                            `<tr>
                                <td><strong>${campaign.Campaign}</strong></td>
                                <td><strong>${campaign['Email click rate']}</strong></td>
                                <td>${parseNumber(campaign['Email clicked']).toLocaleString()}</td>
                                <td>${parseNumber(campaign['Email total clicks']).toLocaleString()}</td>
                                <td>${campaign['Email clicks per unique opens (MPP excluded)'] || 'N/A'}</td>
                            </tr>`
                        ).join('')}
                    </tbody>
                </table>
            `;
            topClickCard.appendChild(clickTableContainer);
            container.appendChild(topClickCard);
            
            dashboard.appendChild(container);
        }
        
        function generateYouTubeAnalytics(dashboard, startDate = null, endDate = null, compareType = 'none') {
            if (!processedData['YouTube_Content.csv']) {
                const container = document.createElement('div');
                container.className = 'dashboard';
                const card = createCard('ðŸŽ¥ YouTube Analytics');
                card.innerHTML += '<p style="text-align: center; padding: 20px; color: var(--duke-gray);">YouTube analytics will be displayed here when you upload your YouTube CSV files.</p>';
                container.appendChild(card);
                dashboard.appendChild(container);
                return;
            }
            
            const container = document.createElement('div');
            container.className = 'dashboard';
            
            // Enhanced YouTube Overview
            let content = processedData['YouTube_Content.csv'];
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                content = content.filter(video => {
                    if (video['Video publish time']) {
                        const publishDate = new Date(video['Video publish time']);
                        return publishDate >= start && publishDate <= end;
                    }
                    return true;
                });
            }
            
            const overviewCard = createCard('ðŸŽ¥ YouTube Channel Overview');
            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'metric-grid';
            
            const totalViews = content.reduce((sum, row) => sum + parseNumber(row.Views), 0);
            const totalWatchTime = content.reduce((sum, row) => sum + parseNumber(row['Watch time (hours)']), 0);
            const totalSubscribers = content.reduce((sum, row) => sum + parseNumber(row.Subscribers), 0);
            const totalImpressions = content.reduce((sum, row) => sum + parseNumber(row.Impressions), 0);
            const avgCTR = content.length > 0 ? 
                content.reduce((sum, row) => sum + parseNumber(row['Impressions click-through rate (%)']), 0) / content.length : 0;
            const totalComments = content.reduce((sum, row) => sum + parseNumber(row['Comments added']), 0);
            const totalLikes = content.reduce((sum, row) => sum + parseNumber(row.Likes), 0);
            const totalShares = content.reduce((sum, row) => sum + parseNumber(row.Shares), 0);
            
            metricsGrid.innerHTML = `
                ${createMetricWithComparison(totalViews, 'Total Views', null)}
                ${createMetricWithComparison(Math.round(totalWatchTime), 'Watch Hours', null)}
                ${createMetricWithComparison(totalSubscribers, 'Subscribers Gained', null)}
                ${createMetricWithComparison(avgCTR.toFixed(1) + '%', 'Avg CTR', null)}
                ${createMetricWithComparison(totalImpressions, 'Total Impressions', null)}
                ${createMetricWithComparison(totalComments + totalLikes + totalShares, 'Total Engagement', null)}
            `;
            
            overviewCard.appendChild(metricsGrid);
            container.appendChild(overviewCard);
            
            // Subscriber vs Non-Subscriber Analysis
            if (processedData['YouTube_Subscription_Status.csv']) {
                const subData = processedData['YouTube_Subscription_Status.csv'];
                const subCard = createCard('ðŸ‘¥ Subscriber vs Non-Subscriber Analysis');
                
                const subMetricsGrid = document.createElement('div');
                subMetricsGrid.className = 'metric-grid';
                
                const subscriberData = subData.find(row => row['Subscription status'] === 'Subscribed') || {};
                const nonSubscriberData = subData.find(row => row['Subscription status'] === 'Not subscribed') || {};
                
                const subscriberViews = parseNumber(subscriberData.Views);
                const nonSubscriberViews = parseNumber(nonSubscriberData.Views);
                const totalSubViews = subscriberViews + nonSubscriberViews;
                
                const subscriberPercentage = totalSubViews > 0 ? (subscriberViews / totalSubViews) * 100 : 0;
                const nonSubscriberPercentage = totalSubViews > 0 ? (nonSubscriberViews / totalSubViews) * 100 : 0;
                
                subMetricsGrid.innerHTML = `
                    <div class="metric">
                        <div class="metric-value">${subscriberPercentage.toFixed(1)}%</div>
                        <div class="metric-label">Subscriber Views</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${nonSubscriberPercentage.toFixed(1)}%</div>
                        <div class="metric-label">Non-Subscriber Views</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${subscriberViews.toLocaleString()}</div>
                        <div class="metric-label">Subscriber View Count</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${nonSubscriberViews.toLocaleString()}</div>
                        <div class="metric-label">Non-Sub View Count</div>
                    </div>
                `;
                
                subCard.appendChild(subMetricsGrid);
                container.appendChild(subCard);
            }
            
            dashboard.appendChild(container);
        }
    </script>
</body>
</html>