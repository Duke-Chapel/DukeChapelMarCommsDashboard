<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --duke-navy: #012169;
            --duke-blue: #00539B;
            --duke-light-blue: #5B9BD5;
            --duke-gray: #666666;
            --duke-light-gray: #E5E5E5;
            --duke-white: #FFFFFF;
            --duke-black: #262626;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            color: var(--duke-black);
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--duke-navy);
            color: var(--duke-white);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin: 0;
        }
        .controls {
            background-color: var(--duke-white);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: var(--duke-gray);
            font-weight: 500;
        }
        input[type="date"], button {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
        }
        button {
            background-color: var(--duke-blue);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            padding: 10px 15px;
            align-self: flex-end;
        }
        button:hover {
            background-color: var(--duke-light-blue);
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: var(--duke-white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin: 0 0 15px 0;
            color: var(--duke-navy);
        }
        .kpi-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .kpi-label {
            font-size: 0.9rem;
            color: var(--duke-gray);
            margin: 0 0 5px 0;
        }
        .kpi-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--duke-blue);
            margin: 0;
        }
        .chart-container {
            position: relative;
            flex-grow: 1;
            min-height: 300px;
        }
        .table-container {
            overflow-x: auto;
            flex-grow: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--duke-light-gray);
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tbody tr:hover {
            background-color: #f1f5f9;
        }
        .loader {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }
    </style>
</head>

<body>
    <header>
        <h1>Marketing Analytics Dashboard</h1>
    </header>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="control-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
            </div>
            <button id="filterButton">Filter</button>
        </div>
        
        <div id="loader" class="loader">Loading and processing data...</div>

        <div id="dashboard" class="dashboard" style="display: none;">
            <div class="card" id="web-analytics">
                <h2 class="card-title">Web Analytics</h2>
                <div class="kpi-container">
                    <div class="kpi"><p class="kpi-label">Total Users</p><p class="kpi-value" id="totalUsers">0</p></div>
                    <div class="kpi"><p class="kpi-label">New Users</p><p class="kpi-value" id="newUsers">0</p></div>
                    <div class="kpi"><p class="kpi-label">Total Sessions</p><p class="kpi-value" id="totalSessions">0</p></div>
                    <div class="kpi"><p class="kpi-label">Engaged Sessions</p><p class="kpi-value" id="engagedSessions">0</p></div>
                </div>
                <div class="chart-container">
                    <canvas id="trafficSourcesChart"></canvas>
                </div>
            </div>

            <div class="card" id="web-demographics">
                <h2 class="card-title">Demographics</h2>
                <div class="chart-container">
                    <canvas id="countryChart"></canvas>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <h2 class="card-title">Top Pages</h2>
                <div class="table-container">
                    <table id="pagesTable">
                        <thead><tr><th>Page Title</th><th>Views</th><th>Total Users</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card" style="grid-column: span 2;">
                <h2 class="card-title">UTM Campaign Performance</h2>
                <div class="table-container">
                    <table id="utmTable">
                        <thead><tr><th>Campaign</th><th>Engaged Sessions</th><th>Key Events (Conversions)</th><th>Engagement Rate</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const chartInstances = {};
        const processedData = {
            web: {}
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            document.getElementById('filterButton').addEventListener('click', updateDashboard);
        });

        function loadAllData() {
            const loader = document.getElementById('loader');
            const dashboard = document.getElementById('dashboard');
            loader.style.display = 'block';
            dashboard.style.display = 'none';

            const filePaths = {
                ga: 'GA_Traffic_Acquisition.xlsx - Sheet1.csv',
                demographics: 'GA_Demographics.xlsx - Sheet1.csv',
                pages: 'GA_Pages_And_Screens.xlsx - Sheet1.csv',
                utm: 'GA_UTMs.xlsx - Sheet1.csv'
            };

            const promises = Object.entries(filePaths).map(([key, path]) => {
                return new Promise((resolve, reject) => {
                    Papa.parse(path, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve({ key, data: results.data }),
                        error: (err) => reject(new Error(`Failed to load ${path}: ${err.message}`))
                    });
                });
            });

            Promise.all(promises)
                .then(results => {
                    const rawData = results.reduce((acc, { key, data }) => {
                        acc[key] = data;
                        return acc;
                    }, {});
                    processWebData(rawData);
                    setDefaultDates();
                    updateDashboard();
                    loader.style.display = 'none';
                    dashboard.style.display = 'grid';
                })
                .catch(error => {
                    loader.textContent = `Error: ${error.message}`;
                    console.error(error);
                });
        }

        function parseDate(dateStr) {
            if (!dateStr || dateStr.length < 8) return null;
            const year = parseInt(dateStr.substring(0, 4), 10);
            const month = parseInt(dateStr.substring(4, 6), 10) - 1;
            const day = parseInt(dateStr.substring(6, 8), 10);
            return new Date(year, month, day);
        }

        function processWebData(rawData) {
            processedData.web.dates = [];
            let minDate = new Date();
            let maxDate = new Date(1970, 0, 1);

            const addDate = (date) => {
                if (date) {
                    if (date < minDate) minDate = date;
                    if (date > maxDate) maxDate = date;
                }
            };
            
            // Process each file and add date for filtering
            processedData.web.ga = rawData.ga.map(row => {
                const date = parseDate(row['Date + hour (YYYYMMDDHH)']);
                addDate(date);
                return { ...row, date };
            });

            processedData.web.demographics = rawData.demographics.map(row => {
                const date = parseDate(row['Date + hour (YYYYMMDDHH)']);
                addDate(date);
                return { ...row, date };
            });

            processedData.web.pages = rawData.pages.map(row => {
                const date = parseDate(row['Date + hour (YYYYMMDDHH)']);
                addDate(date);
                return { ...row, date };
            });

            processedData.web.utm = rawData.utm.map(row => {
                const date = parseDate(row['Date + hour (YYYYMMDDHH)']);
                addDate(date);
                return { ...row, date };
            });

            processedData.web.minDate = minDate;
            processedData.web.maxDate = maxDate;
        }

        function setDefaultDates() {
            const endDateInput = document.getElementById('endDate');
            const startDateInput = document.getElementById('startDate');
            
            const endDate = processedData.web.maxDate;
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 30);

            endDateInput.value = endDate.toISOString().split('T')[0];
            startDateInput.value = startDate.toISOString().split('T')[0];
        }

        function updateDashboard() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999); // Include the whole end day

            const filterByDate = (data) => data.filter(row => row.date >= startDate && row.date <= endDate);

            const filteredWebData = {
                ga: filterByDate(processedData.web.ga),
                demographics: filterByDate(processedData.web.demographics),
                pages: filterByDate(processedData.web.pages),
                utm: filterByDate(processedData.web.utm)
            };

            updateWebAnalytics(filteredWebData);
        }
        
        function formatNumber(num) {
            return num.toLocaleString();
        }

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
            }
        }

        function updateWebAnalytics(data) {
            // KPIs
            let totalUsers = 0, newUsers = 0, engagedSessions = 0, totalSessions = 0;
            data.demographics.forEach(row => {
                totalUsers += parseInt(row['Total users']) || 0;
                newUsers += parseInt(row['New users']) || 0;
                engagedSessions += parseInt(row['Engaged sessions']) || 0;
            });
            data.ga.forEach(row => {
                totalSessions += parseInt(row['Sessions']) || 0;
            });

            document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
            document.getElementById('newUsers').textContent = formatNumber(newUsers);
            document.getElementById('totalSessions').textContent = formatNumber(totalSessions);
            document.getElementById('engagedSessions').textContent = formatNumber(engagedSessions);

            // Traffic Sources Chart
            destroyChart('traffic');
            const trafficSources = data.ga.reduce((acc, row) => {
                const source = row['Session source / medium'] || 'Unknown';
                const sessions = parseInt(row['Sessions']) || 0;
                acc[source] = (acc[source] || 0) + sessions;
                return acc;
            }, {});
            const sortedTraffic = Object.entries(trafficSources).sort((a, b) => b[1] - a[1]);
            chartInstances.traffic = new Chart(document.getElementById('trafficSourcesChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: sortedTraffic.map(item => item[0]),
                    datasets: [{ data: sortedTraffic.map(item => item[1]), backgroundColor: ['#012169', '#00539B', '#5B9BD5', '#A9C4E5', '#E5E5E5'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Sessions by Source / Medium' } } }
            });

            // Country Chart
            destroyChart('country');
            const usersByCountry = data.demographics.reduce((acc, row) => {
                const country = row['Country'];
                if (country && country !== '(not set)') {
                    acc[country] = (acc[country] || 0) + (parseInt(row['Total users']) || 0);
                }
                return acc;
            }, {});
            const sortedCountries = Object.entries(usersByCountry).sort(([, a], [, b]) => b - a).slice(0, 5);
            chartInstances.country = new Chart(document.getElementById('countryChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sortedCountries.map(([country]) => country),
                    datasets: [{ label: 'Total Users', data: sortedCountries.map(([, users]) => users), backgroundColor: '#00539B' }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Top 5 Countries by Users' } } }
            });

            // Top Pages Table
            const pagesBody = document.querySelector("#pagesTable tbody");
            pagesBody.innerHTML = '';
            const aggregatedPages = data.pages.reduce((acc, row) => {
                const title = row['Page title and screen class'];
                if (!acc[title]) acc[title] = { views: 0, users: 0 };
                acc[title].views += parseInt(row['Views']) || 0;
                acc[title].users += parseInt(row['Total users']) || 0;
                return acc;
            }, {});
            Object.entries(aggregatedPages).sort(([,a],[,b]) => b.views - a.views).slice(0, 10).forEach(([title, data]) => {
                pagesBody.innerHTML += `<tr><td>${title}</td><td>${formatNumber(data.views)}</td><td>${formatNumber(data.users)}</td></tr>`;
            });
            
            // UTM Table
            const utmBody = document.querySelector("#utmTable tbody");
            utmBody.innerHTML = '';
            const aggregatedUtms = data.utm.reduce((acc, row) => {
                const campaign = row['Manual campaign name'];
                if (!acc[campaign]) acc[campaign] = { engagedSessions: 0, keyEvents: 0, totalRate: 0, count: 0 };
                acc[campaign].engagedSessions += parseInt(row['Engaged sessions']) || 0;
                acc[campaign].keyEvents += parseInt(row['Key events']) || 0;
                acc[campaign].totalRate += parseFloat(row['Engagement rate']) || 0;
                acc[campaign].count++;
                return acc;
            }, {});
            Object.entries(aggregatedUtms).sort(([,a],[,b]) => b.engagedSessions - a.engagedSessions).slice(0, 10).forEach(([campaign, data]) => {
                const avgRate = data.count > 0 ? (data.totalRate / data.count * 100).toFixed(2) : 0;
                utmBody.innerHTML += `<tr><td>${campaign}</td><td>${formatNumber(data.engagedSessions)}</td><td>${formatNumber(data.keyEvents)}</td><td>${avgRate}%</td></tr>`;
            });
        }
    </script>
</body>

</html>