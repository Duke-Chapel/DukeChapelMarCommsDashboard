<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --duke-navy: #012169;
            --duke-blue: #00539B;
            --duke-light-blue: #5B9BD5;
            --duke-gray: #666666;
            --duke-light-gray: #E5E5E5;
            --duke-white: #FFFFFF;
            --duke-black: #262626;
            --change-positive: #198754;
            --change-negative: #dc3545;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f9; margin: 0; padding: 0; color: var(--duke-black); }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--duke-navy); color: var(--duke-white); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; }
        .controls { background-color: var(--duke-white); padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.8rem; margin-bottom: 5px; color: var(--duke-gray); font-weight: 500; }
        input[type="date"], select, button { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-family: 'Inter', sans-serif; }
        button { background-color: var(--duke-blue); color: white; cursor: pointer; transition: background-color 0.3s; border: none; padding: 10px 15px; align-self: flex-end; margin-left: auto;}
        button:hover { background-color: var(--duke-light-blue); }
        .tab-bar { display: flex; border-bottom: 2px solid var(--duke-light-gray); margin-bottom: 20px; }
        .tab-button { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 1.1rem; font-weight: 600; color: var(--duke-gray); border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-button.active { color: var(--duke-navy); border-bottom-color: var(--duke-navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background-color: var(--duke-white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0 0 15px 0; color: var(--duke-navy); }
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .kpi-label { font-size: 0.9rem; color: var(--duke-gray); margin: 0 0 5px 0; }
        .kpi-value { font-size: 1.75rem; font-weight: bold; color: var(--duke-blue); margin: 0; }
        .kpi-comparison { font-size: 0.85rem; margin: 4px 0 0 0; font-weight: 500; }
        .kpi-comparison.positive { color: var(--change-positive); }
        .kpi-comparison.negative { color: var(--change-negative); }
        .chart-container { position: relative; flex-grow: 1; min-height: 300px; }
        .demographics-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex-grow: 1; }
        .demographics-container .chart-container { min-height: 250px; }
        .table-container { overflow-x: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--duke-light-gray); }
        th { background-color: #f8f9fa; font-weight: 600; }
        tbody tr:hover { background-color: #f1f5f9; }
        .loader-container { text-align: center; padding: 40px; }
        .loader { font-size: 1.2rem; margin-bottom: 20px; }
        #status-panel { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: left; font-family: monospace; max-width: 800px; margin: 20px auto; line-height: 1.6; }
    </style>
</head>
<body>
    <header><h1>Marketing Analytics Dashboard</h1></header>

    <div class="container">
        <div class="controls">
             <div class="control-group">
                <label for="dateRange">Date Range</label>
                <select id="dateRange">
                    <option value="custom">Custom Range</option>
                    <option value="last7days">Last 7 Days</option>
                    <option value="last30days" selected>Last 30 Days</option>
                    <option value="thisMonth">This Month</option>
                    <option value="lastMonth">Last Month</option>
                </select>
            </div>
             <div class="control-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="control-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
            </div>
            <button id="filterButton">Update</button>
        </div>

        <div class="tab-bar">
            <button class="tab-button" onclick="openTab(event, 'web')">Web</button>
            <button class="tab-button" onclick="openTab(event, 'social')">Social</button>
            <button class="tab-button" onclick="openTab(event, 'email')">Email</button>
            <button class="tab-button" onclick="openTab(event, 'youtube')">YouTube</button>
        </div>
        
        <div id="loader-container" class="loader-container">
            <div id="loader" class="loader">Connecting to Google Drive...</div>
            <div id="status-panel" style="display: none;"></div>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div id="web" class="tab-content">
                <div class="dashboard">
                    <div class="card" id="web-analytics">
                        <h2 class="card-title">Web KPIs</h2>
                        <div class="kpi-container">
                            <div class="kpi">
                                <p class="kpi-label">Total Users</p>
                                <p class="kpi-value" id="totalUsers">0</p>
                                <p class="kpi-comparison" id="totalUsers-pop">--</p>
                            </div>
                            <div class="kpi">
                                <p class="kpi-label">New Users</p>
                                <p class="kpi-value" id="newUsers">0</p>
                                <p class="kpi-comparison" id="newUsers-pop">--</p>
                            </div>
                            <div class="kpi">
                                <p class="kpi-label">Total Sessions</p>
                                <p class="kpi-value" id="totalSessions">0</p>
                                <p class="kpi-comparison" id="totalSessions-pop">--</p>
                            </div>
                            <div class="kpi">
                                <p class="kpi-label">Engaged Sessions</p>
                                <p class="kpi-value" id="engagedSessions">0</p>
                                <p class="kpi-comparison" id="engagedSessions-pop">--</p>
                            </div>
                        </div>
                         <h2 class="card-title" style="margin-top: 20px;">Traffic Sources</h2>
                        <div class="chart-container">
                            <canvas id="trafficSourcesChart"></canvas>
                        </div>
                    </div>
        
                    <div class="card" id="web-demographics" style="grid-column: span 2;">
                        <h2 class="card-title">Audience Demographics</h2>
                        <div class="demographics-container">
                             <div class="chart-container"><canvas id="countryChart"></canvas></div>
                            <div class="chart-container"><canvas id="ageChart"></canvas></div>
                            <div class="chart-container" style="grid-column: 1 / -1;"><canvas id="genderChart"></canvas></div>
                        </div>
                    </div>
        
                    <div class="card" style="grid-column: 1 / -1;">
                        <h2 class="card-title">Top Landing Pages</h2>
                        <div class="table-container">
                            <table id="pagesTable">
                                <thead><tr><th>Landing Page</th><th>Sessions</th><th>Avg. Engagement Time</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
             <div id="social" class="tab-content"></div>
             <div id="email" class="tab-content"></div>
             <div id="youtube" class="tab-content"></div>
        </div>
    </div>
    
    <script>
        const API_KEY = 'YOUR_API_KEY'; // Replace with your Google API Key
        const FOLDER_ID = 'YOUR_FOLDER_ID'; // Replace with your Google Drive Folder ID
        const SHEET_NAME = 'Sheet1';
        const FILENAME_TO_KEY_MAP = {
            'GA_Traffic_Acquisition': 'gaTraffic', 
            'GA_Demographics': 'gaDemographics', 
            'GA_Pages_And_Screens': 'gaPages',
        };

        const chartInstances = {};
        let processedData = {};

        document.addEventListener('DOMContentLoaded', () => {
            if (API_KEY === 'YOUR_API_KEY' || FOLDER_ID === 'YOUR_FOLDER_ID') {
                document.getElementById('loader').textContent = 'Please configure API_KEY and FOLDER_ID in the script.';
                return;
            }
            loadAllData();
            document.getElementById('filterButton').addEventListener('click', updateDashboard);
            document.getElementById('dateRange').addEventListener('change', handleDateRangePreset);
        });

        function handleDateRangePreset(event) {
            const preset = event.target.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            let startDate, endDate;
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            switch (preset) {
                case 'last7days':
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() - 1); // Yesterday
                    startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - 6);
                    break;
                case 'last30days':
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() - 1); // Yesterday
                    startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - 29);
                    break;
                case 'thisMonth':
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() - 1); // Yesterday
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'lastMonth':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate = new Date(lastMonth);
                    endDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
                    break;
                case 'custom':
                default:
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    return; 
            }
            
            startDateInput.value = startDate.toISOString().split('T')[0];
            endDateInput.value = endDate.toISOString().split('T')[0];
            startDateInput.disabled = true;
            endDateInput.disabled = true;

            updateDashboard();
        }

        async function loadAllData() {
            // ... (loadAllData function remains largely the same)
            // It fetches data, then calls processAllData, and finally...
            handleDateRangePreset({ target: { value: 'last30days' } }); // Set initial default view
            openTab(null, 'web');
        }

        function updateDashboard() {
            const startDate = new Date(document.getElementById('startDate').value + 'T00:00:00');
            const endDate = new Date(document.getElementById('endDate').value + 'T23:59:59');
            
            // Calculate previous period
            const diff = endDate.getTime() - startDate.getTime();
            const prevEndDate = new Date(startDate.getTime() - 1);
            const prevStartDate = new Date(prevEndDate.getTime() - diff);

            const filterDataForPeriod = (start, end) => {
                const filtered = {};
                for (const key in processedData) {
                    if (Array.isArray(processedData[key])) {
                        filtered[key] = processedData[key].filter(row => row.date && row.date >= start && row.date <= end);
                    }
                }
                return filtered;
            };

            const currentPeriodData = filterDataForPeriod(startDate, endDate);
            const previousPeriodData = filterDataForPeriod(prevStartDate, prevEndDate);

            updateWebAnalytics(currentPeriodData, previousPeriodData);
        }

        function calculatePoP(current, previous) {
            const popElement = document.createElement('p');
            popElement.className = 'kpi-comparison';
            if (previous === 0) {
                popElement.textContent = 'vs ∞'; // Or 'N/A'
                return popElement;
            }
            const change = ((current - previous) / previous) * 100;
            popElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
            popElement.classList.add(change >= 0 ? 'positive' : 'negative');
            return popElement;
        }

        function updateWebAnalytics(currentData, previousData) {
            if (!currentData.gaTraffic || !currentData.gaDemographics || !currentData.gaPages) {
                console.warn("One or more Google Analytics data sources are missing for the current period.");
                return;
            }

            // --- KPIs with PoP ---
            const calculateKpis = (data) => {
                let kpis = { totalUsers: 0, newUsers: 0, totalSessions: 0, engagedSessions: 0 };
                if (data && data.gaTraffic) {
                    data.gaTraffic.forEach(row => {
                        kpis.totalUsers += parseInt(row['Total users']) || 0;
                        kpis.newUsers += parseInt(row['New users']) || 0;
                        kpis.totalSessions += parseInt(row['Sessions']) || 0;
                        kpis.engagedSessions += parseInt(row['Engaged sessions']) || 0;
                    });
                }
                return kpis;
            };

            const currentKpis = calculateKpis(currentData);
            const previousKpis = calculateKpis(previousData);

            document.getElementById('totalUsers').textContent = formatNumber(currentKpis.totalUsers);
            document.getElementById('totalUsers-pop').replaceWith(calculatePoP(currentKpis.totalUsers, previousKpis.totalUsers));
            document.getElementById('totalUsers-pop').id = 'totalUsers-pop'; // re-assign id

            document.getElementById('newUsers').textContent = formatNumber(currentKpis.newUsers);
            document.getElementById('newUsers-pop').replaceWith(calculatePoP(currentKpis.newUsers, previousKpis.newUsers));
            document.getElementById('newUsers-pop').id = 'newUsers-pop';

            document.getElementById('totalSessions').textContent = formatNumber(currentKpis.totalSessions);
            document.getElementById('totalSessions-pop').replaceWith(calculatePoP(currentKpis.totalSessions, previousKpis.totalSessions));
            document.getElementById('totalSessions-pop').id = 'totalSessions-pop';
            
            document.getElementById('engagedSessions').textContent = formatNumber(currentKpis.engagedSessions);
            document.getElementById('engagedSessions-pop').replaceWith(calculatePoP(currentKpis.engagedSessions, previousKpis.engagedSessions));
            document.getElementById('engagedSessions-pop').id = 'engagedSessions-pop';

            // --- Charts and Tables (using current period data only) ---
            // ... (The rest of the updateWebAnalytics function for charts and tables remains the same)
        }

        // --- Other Utility Functions (openTab, getSpreadsheetIdsFromFolder, etc.) ---
        // ... (These functions remain the same as the previous version)

        function formatNumber(num) { return num ? Number(num).toLocaleString() : '0'; }

        function parseDate(dateStr) {
            if (!dateStr || String(dateStr).length < 8) return null;
            try {
                const s = String(dateStr);
                const year = parseInt(s.substring(0, 4), 10);
                const month = parseInt(s.substring(4, 6), 10) - 1;
                const day = parseInt(s.substring(6, 8), 10);
                const date = new Date(Date.UTC(year, month, day));
                return isNaN(date) ? null : date;
            } catch (e) {
                return null;
            }
        }
        // ... (And so on for the other utility functions like createOrUpdateChart, aggregateData, etc.)

    </script>
</body>
</html>