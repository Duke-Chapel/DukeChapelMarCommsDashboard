<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Chapel Marketing Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --duke-navy: #012169;
            --duke-blue: #00539B;
            --duke-light-blue: #5B9BD5;
            --duke-gray: #666666;
            --duke-light-gray: #E5E5E5;
            --duke-white: #FFFFFF;
            --duke-black: #262626;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f9; margin: 0; padding: 0; color: var(--duke-black); }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--duke-navy); color: var(--duke-white); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; }
        .controls { background-color: var(--duke-white); padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 20px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 0.8rem; margin-bottom: 5px; color: var(--duke-gray); font-weight: 500; }
        input[type="date"], button { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-family: 'Inter', sans-serif; }
        button { background-color: var(--duke-blue); color: white; cursor: pointer; transition: background-color 0.3s; border: none; padding: 10px 15px; align-self: flex-end; }
        button:hover { background-color: var(--duke-light-blue); }
        .tab-bar { display: flex; border-bottom: 2px solid var(--duke-light-gray); margin-bottom: 20px; }
        .tab-button { padding: 12px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 1.1rem; font-weight: 600; color: var(--duke-gray); border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-button.active { color: var(--duke-navy); border-bottom-color: var(--duke-navy); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background-color: var(--duke-white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0 0 15px 0; color: var(--duke-navy); }
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .kpi-label { font-size: 0.9rem; color: var(--duke-gray); margin: 0 0 5px 0; }
        .kpi-value { font-size: 1.75rem; font-weight: bold; color: var(--duke-blue); margin: 0; }
        .chart-container { position: relative; flex-grow: 1; min-height: 300px; }
        .table-container { overflow-x: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--duke-light-gray); }
        th { background-color: #f8f9fa; font-weight: 600; }
        tbody tr:hover { background-color: #f1f5f9; }
        .loader-container { text-align: center; padding: 40px; }
        .loader { font-size: 1.2rem; margin-bottom: 20px; }
        #status-panel { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: left; font-family: monospace; max-width: 800px; margin: 20px auto; line-height: 1.6; }
        #status-panel h3 { margin-top: 0; font-family: 'Inter', sans-serif; color: var(--duke-navy) }
        #status-panel .status-found { color: #198754; font-weight: bold; }
        #status-panel .status-missing { color: #dc3545; font-weight: bold; }
        #status-panel ul { list-style-type: none; padding-left: 0; }
    </style>
</head>
<body>
    <header><h1>Marketing Analytics Dashboard</h1></header>

    <div class="container">
        <div class="controls">
             <div class="control-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="control-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
            </div>
            <button id="filterButton">Filter</button>
        </div>

        <div class="tab-bar">
            <button class="tab-button" onclick="openTab(event, 'web')">Web</button>
            <button class="tab-button" onclick="openTab(event, 'social')">Social</button>
            <button class="tab-button" onclick="openTab(event, 'email')">Email</button>
            <button class="tab-button" onclick="openTab(event, 'youtube')">YouTube</button>
        </div>
        
        <div id="loader-container" class="loader-container">
            <div id="loader" class="loader">Connecting to Google Drive...</div>
            <div id="status-panel" style="display: none;">
                <h3>API Connection Status</h3>
                <div id="status-message"></div>
                <ul id="status-list"></ul>
            </div>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div id="web" class="tab-content">
                <div class="dashboard">
                    <div class="card" id="web-analytics">
                        <h2 class="card-title">Web Analytics</h2>
                        <div class="kpi-container">
                            <div class="kpi"><p class="kpi-label">Total Users</p><p class="kpi-value" id="totalUsers">0</p></div>
                            <div class="kpi"><p class="kpi-label">New Users</p><p class="kpi-value" id="newUsers">0</p></div>
                            <div class="kpi"><p class="kpi-label">Total Sessions</p><p class="kpi-value" id="totalSessions">0</p></div>
                            <div class="kpi"><p class="kpi-label">Engaged Sessions</p><p class="kpi-value" id="engagedSessions">0</p></div>
                        </div>
                        <div class="chart-container">
                            <canvas id="trafficSourcesChart"></canvas>
                        </div>
                    </div>
        
                    <div class="card" id="web-demographics">
                        <h2 class="card-title">Demographics</h2>
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
        
                    <div class="card" style="grid-column: span 2;">
                        <h2 class="card-title">Top Pages</h2>
                        <div class="table-container">
                            <table id="pagesTable">
                                <thead><tr><th>Page Title</th><th>Views</th><th>Total Users</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card" style="grid-column: span 2;">
                        <h2 class="card-title">UTM Campaign Performance</h2>
                        <div class="table-container">
                            <table id="utmTable">
                                <thead><tr><th>Campaign</th><th>Engaged Sessions</th><th>Key Events (Conversions)</th><th>Engagement Rate</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="social" class="tab-content">
                <div class="dashboard">
                     <div class="card"><h2 class="card-title">Social KPIs</h2><div class="kpi-container"><div class="kpi"><p class="kpi-label">Total Followers</p><p class="kpi-value" id="totalFollowers">0</p></div><div class="kpi"><p class="kpi-label">Total Reach</p><p class="kpi-value" id="totalReach">0</p></div><div class="kpi"><p class="kpi-label">Total Interactions</p><p class="kpi-value" id="totalInteractions">0</p></div></div></div>
                     <div class="card" style="grid-column: span 2;"><h2 class="card-title">Followers by Platform</h2><div class="chart-container"><canvas id="followersByPlatformChart"></canvas></div></div>
                </div>
            </div>
            <div id="email" class="tab-content">
                <div class="card"><h2 class="card-title">Email Analytics</h2><p>This section is under construction.</p></div>
            </div>
            <div id="youtube" class="tab-content">
                <div class="card"><h2 class="card-title">YouTube Analytics</h2><p>This section is under construction.</p></div>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyAqoLAJLVZyScFX6cG4eSJiroMkA4KH-nE'; // IMPORTANT: Replace with your actual Google API Key
        const FOLDER_ID = '1Kc8tHlVmPYMtNipycBRd0HSC61u2uLDP'; // IMPORTANT: Replace with your Google Drive Folder ID
        const SHEET_NAME = 'Sheet1';

        const FILENAME_TO_KEY_MAP = {
            'GA_Traffic_Acquisition': 'gaTraffic', 
            'GA_Demographics': 'gaDemographics', 
            'GA_Pages_And_Screens': 'gaPages', 
            'GA_UTMs': 'gaUtms',
            'Email_Campaign_Performance': 'emailCampaigns', 
            'FB_Audience': 'fbAudience', 'FB_Follows': 'fbFollows', 'FB_Interactions': 'fbInteractions', 'FB_Link_Clicks': 'fbLinkClicks', 'FB_Reach': 'fbReach', 'FB_Views': 'fbViews', 'FB_Visits': 'fbVisits', 
            'IG_Audience': 'igAudience', 'IG_Follows': 'igFollows', 'IG_Interactions': 'igInteractions', 'IG_Link_Clicks': 'igLinkClicks', 'IG_Reach': 'igReach', 'IG_Views': 'igViews', 'IG_Visits': 'igVisits', 
            'YouTube_Age': 'ytAge', 'YouTube_Content': 'ytContent', 'YouTube_Gender': 'ytGender', 'YouTube_Geography': 'ytGeo', 'YouTube_Subscription_Status': 'ytSubStatus'
        };
        // --- END CONFIGURATION ---

        const chartInstances = {};
        const processedData = {};

        document.addEventListener('DOMContentLoaded', () => {
            if (API_KEY === 'YOUR_API_KEY' || FOLDER_ID === 'YOUR_FOLDER_ID') {
                document.getElementById('loader').textContent = 'Please configure API_KEY and FOLDER_ID in the script.';
                return;
            }
            loadAllData();
            document.getElementById('filterButton').addEventListener('click', updateDashboard);
        });

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            } else {
                // Find button to activate when called programmatically
                const activeButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.getAttribute('onclick').includes(`'${tabName}'`));
                if (activeButton) activeButton.classList.add('active');
            }
        }

        async function getSpreadsheetIdsFromFolder(statusListElem) {
            const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}' in parents and trashed=false&key=${API_KEY}&fields=files(id,name)`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Google Drive API error! Status: ${response.status}. Check Folder ID, API Key, and Sharing Permissions.`);
            
            const data = await response.json();
            const foundFiles = data.files || [];
            
            const spreadsheetIds = {};
            const requiredFiles = Object.keys(FILENAME_TO_KEY_MAP);
            let matchedFileCount = 0;

            requiredFiles.forEach(requiredName => {
                const foundFile = foundFiles.find(f => f.name === requiredName);
                const key = FILENAME_TO_KEY_MAP[requiredName];
                const statusItem = document.createElement('li');

                if (foundFile) {
                    spreadsheetIds[key] = foundFile.id;
                    statusItem.innerHTML = `[<span class="status-found">FOUND</span>] ${requiredName}`;
                    matchedFileCount++;
                } else {
                    statusItem.innerHTML = `[<span class="status-missing">MISSING</span>] ${requiredName}`;
                }
                statusListElem.appendChild(statusItem);
            });

            if (matchedFileCount === 0) {
                throw new Error("No required files were found in the Google Drive folder. Please check the filenames and try again.");
            }
            return spreadsheetIds;
        }
        
        async function loadAllData() {
            const loader = document.getElementById('loader');
            const statusPanel = document.getElementById('status-panel');
            const statusList = document.getElementById('status-list');
            const statusMessage = document.getElementById('status-message');
            const dashboard = document.getElementById('dashboard-content');
            
            statusPanel.style.display = 'block';
            dashboard.style.display = 'none';

            try {
                const spreadsheetIds = await getSpreadsheetIdsFromFolder(statusList);
                
                statusMessage.textContent = `Found ${Object.keys(spreadsheetIds).length} matching file(s). Now fetching data...`;
                loader.textContent = 'Loading data from Google Sheets...';

                const keysToFetch = Object.keys(spreadsheetIds);
                const promises = keysToFetch.map(key => {
                    const sheetId = spreadsheetIds[key];
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${SHEET_NAME}?key=${API_KEY}`;
                    return fetch(url).then(res => res.json()).then(data => ({ 
                        key, 
                        data: googleSheetsValuesToObjects(data.values) 
                    })).catch(err => {
                        console.error(`Failed to fetch or process ${key}`, err);
                        return { key, data: [] }; // Return empty data on failure
                    });
                });

                const results = await Promise.all(promises);
                const rawData = results.reduce((acc, { key, data }) => { acc[key] = data; return acc; }, {});
                
                processAllData(rawData);
                setDefaultDates();
                updateDashboard();
                
                document.getElementById('loader-container').style.display = 'none';
                dashboard.style.display = 'block';
                openTab(null, 'web');

            } catch (error) {
                loader.textContent = 'An error occurred!';
                statusMessage.innerHTML = `<span class="status-missing">${error.message}</span>`;
                console.error(error);
            }
        }
        
        function processAllData(rawData) {
            let minDate = new Date();
            let maxDate = new Date(1970, 0, 1);
            const addDate = (date) => {
                if (date && !isNaN(date)) {
                    if (date < minDate) minDate = date;
                    if (date > maxDate) maxDate = date;
                }
            };
            
            for (const key in rawData) {
                if (Array.isArray(rawData[key])) {
                    processedData[key] = rawData[key].map(row => {
                        const dateString = row['Date + hour (YYYYMMDDHH)'] || row['Date'];
                        const date = parseDate(dateString);
                        addDate(date);
                        return { ...row, date };
                    });
                }
            }
            processedData.minDate = minDate;
            processedData.maxDate = maxDate;
        }

        function updateDashboard() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999);

            const filterByDate = (data) => data ? data.filter(row => row.date && row.date >= startDate && row.date <= endDate) : [];

            const filteredData = {};
            for (const key in processedData) {
                if(Array.isArray(processedData[key])) {
                     filteredData[key] = filterByDate(processedData[key]);
                }
            }
            
            updateWebAnalytics(filteredData);
            updateSocialAnalytics(filteredData);
        }

        function updateWebAnalytics(data) {
            const { gaDemographics, gaTraffic, gaPages, gaUtms } = data;
            if (!gaDemographics || !gaTraffic || !gaPages || !gaUtms) {
                console.warn("One or more Google Analytics data sources are missing for the selected date range.");
                return;
            }

            // KPIs
            let totalUsers = 0, newUsers = 0, engagedSessions = 0, totalSessions = 0;
            gaDemographics.forEach(row => {
                totalUsers += parseInt(row['Total users']) || 0;
                newUsers += parseInt(row['New users']) || 0;
                engagedSessions += parseInt(row['Engaged sessions']) || 0;
            });
            gaTraffic.forEach(row => {
                totalSessions += parseInt(row['Sessions']) || 0;
            });

            document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
            document.getElementById('newUsers').textContent = formatNumber(newUsers);
            document.getElementById('totalSessions').textContent = formatNumber(totalSessions);
            document.getElementById('engagedSessions').textContent = formatNumber(engagedSessions);

            // Traffic Sources Chart
            destroyChart('traffic');
            const trafficSources = gaTraffic.reduce((acc, row) => {
                const source = row['Session source / medium'] || 'Unknown';
                const sessions = parseInt(row['Sessions']) || 0;
                acc[source] = (acc[source] || 0) + sessions;
                return acc;
            }, {});
            const sortedTraffic = Object.entries(trafficSources).sort((a, b) => b[1] - a[1]);
            chartInstances.traffic = new Chart(document.getElementById('trafficSourcesChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: sortedTraffic.map(item => item[0]),
                    datasets: [{ data: sortedTraffic.map(item => item[1]), backgroundColor: ['#012169', '#00539B', '#5B9BD5', '#A9C4E5', '#E5E5E5'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Sessions by Source / Medium' } } }
            });

            // Country Chart
            destroyChart('country');
            const usersByCountry = gaDemographics.reduce((acc, row) => {
                const country = row['Country'];
                if (country && country !== '(not set)') {
                    acc[country] = (acc[country] || 0) + (parseInt(row['Total users']) || 0);
                }
                return acc;
            }, {});
            const sortedCountries = Object.entries(usersByCountry).sort(([, a], [, b]) => b - a).slice(0, 5);
            chartInstances.country = new Chart(document.getElementById('countryChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sortedCountries.map(([country]) => country),
                    datasets: [{ label: 'Total Users', data: sortedCountries.map(([, users]) => users), backgroundColor: '#00539B' }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Top 5 Countries by Users' } } }
            });

            // Top Pages Table
            const pagesBody = document.querySelector("#pagesTable tbody");
            pagesBody.innerHTML = '';
            const aggregatedPages = gaPages.reduce((acc, row) => {
                const title = row['Page title and screen class'];
                if (title && title !== '(not set)') {
                    if (!acc[title]) acc[title] = { views: 0, users: 0 };
                    acc[title].views += parseInt(row['Views']) || 0;
                    acc[title].users += parseInt(row['Total users']) || 0;
                }
                return acc;
            }, {});
            Object.entries(aggregatedPages).sort(([,a],[,b]) => b.views - a.views).slice(0, 10).forEach(([title, data]) => {
                pagesBody.innerHTML += `<tr><td>${title}</td><td>${formatNumber(data.views)}</td><td>${formatNumber(data.users)}</td></tr>`;
            });
            
            // UTM Table
            const utmBody = document.querySelector("#utmTable tbody");
            utmBody.innerHTML = '';
            const aggregatedUtms = gaUtms.reduce((acc, row) => {
                const campaign = row['Manual campaign name'];
                 if (campaign && campaign !== '(not set)') {
                    if (!acc[campaign]) acc[campaign] = { engagedSessions: 0, keyEvents: 0, totalRate: 0, count: 0 };
                    acc[campaign].engagedSessions += parseInt(row['Engaged sessions']) || 0;
                    acc[campaign].keyEvents += parseInt(row['Key events']) || 0;
                    acc[campaign].totalRate += parseFloat(row['Engagement rate']) || 0;
                    acc[campaign].count++;
                }
                return acc;
            }, {});
            Object.entries(aggregatedUtms).sort(([,a],[,b]) => b.engagedSessions - a.engagedSessions).slice(0, 10).forEach(([campaign, data]) => {
                const avgRate = data.count > 0 ? (data.totalRate / data.count * 100).toFixed(2) : 0;
                utmBody.innerHTML += `<tr><td>${campaign}</td><td>${formatNumber(data.engagedSessions)}</td><td>${formatNumber(data.keyEvents)}</td><td>${avgRate}%</td></tr>`;
            });
        }
        
        function updateSocialAnalytics(data) {
            const { fbFollows, igFollows, fbReach, igReach, fbInteractions, igInteractions } = data;
            if (!fbFollows || !igFollows) return;
            
            const lastFbFollowers = fbFollows.length > 0 ? parseInt(fbFollows[fbFollows.length - 1]['Value']) : 0;
            const lastIgFollowers = igFollows.length > 0 ? parseInt(igFollows[igFollows.length - 1]['Value']) : 0;
            document.getElementById('totalFollowers').textContent = formatNumber(lastFbFollowers + lastIgFollowers);

            const totalReach = ((fbReach || []).reduce((sum, row) => sum + parseInt(row['Value']), 0)) + ((igReach || []).reduce((sum, row) => sum + parseInt(row['Value']), 0));
            document.getElementById('totalReach').textContent = formatNumber(totalReach);
            
            const totalInteractions = ((fbInteractions || []).reduce((sum, row) => sum + parseInt(row['Value']), 0)) + ((igInteractions || []).reduce((sum, row) => sum + parseInt(row['Value']), 0));
            document.getElementById('totalInteractions').textContent = formatNumber(totalInteractions);

            const followersByPlatform = { 'Facebook': lastFbFollowers, 'Instagram': lastIgFollowers };
            
            destroyChart('followersByPlatformChart');
            chartInstances['followersByPlatformChart'] = new Chart(document.getElementById('followersByPlatformChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(followersByPlatform),
                    datasets: [{
                        label: 'Followers',
                        data: Object.values(followersByPlatform),
                        backgroundColor: ['#012169', '#00539B']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Followers by Platform' } } }
            });
        }

        // --- UTILITY FUNCTIONS ---
        function setDefaultDates() {
            const endDateInput = document.getElementById('endDate');
            const startDateInput = document.getElementById('startDate');
            
            const endDate = (processedData.maxDate && !isNaN(processedData.maxDate)) ? processedData.maxDate : new Date();
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 30);

            endDateInput.value = endDate.toISOString().split('T')[0];
            startDateInput.value = startDate.toISOString().split('T')[0];
        }
        function formatNumber(num) { return num ? Number(num).toLocaleString() : '0'; }
        function destroyChart(chartId) { if (chartInstances[chartId]) chartInstances[chartId].destroy(); }
        
        function googleSheetsValuesToObjects(values) {
            if (!values || values.length < 2) return [];
            const headers = values[0];
            return values.slice(1).map(row => headers.reduce((obj, header, i) => {
                obj[header] = row[i];
                return obj;
            }, {}));
        }

        function parseDate(dateStr) {
            if (!dateStr || dateStr.length < 8) return null;
            try {
                const year = parseInt(dateStr.substring(0, 4), 10);
                const month = parseInt(dateStr.substring(4, 6), 10) - 1;
                const day = parseInt(dateStr.substring(6, 8), 10);
                const date = new Date(year, month, day);
                return isNaN(date) ? null : date;
            } catch (e) {
                return null;
            }
        }
    </script>
</body>
</html>